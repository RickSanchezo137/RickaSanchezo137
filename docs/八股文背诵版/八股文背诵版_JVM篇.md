# [返回](/)

# 八股文背诵版之—JVM篇

## 基础知识

:point_right:**知道深拷贝和浅拷贝吗？**

知道。对一个对象的拷贝，浅拷贝对其基本数据类型的属性和引用类型属性的地址都是进行值传递的，因此，两个对象中相对应的引用类型的属性会指向同一个内存地址；深拷贝对其基本数据类型进行值传递，对引用类型创建一个全新的对象，并复制其内容，因此两个对象中对应的引用类型的属性，会指向不同的内存地址。Object的clone()方法是浅拷贝，需要对其进行重写实现深拷贝

![image-20220105164902566](imgs\JVM\2.png)

:point_right:**讲一下JVM主要组成部分？**

> 两个子系统（类加载、执行引擎）、两个组件（运行时数据区、本地方法接口）

JVM主要由类加载子系统、执行引擎、运行时数据区和本地方法接口来组成

其中类加载子系统用于将二进制Class文件或运行过程中动态生成的字节码加载到内存中去，主要包括类的装载，链接、初始化这三个步骤；执行引擎主要用于对字节码文件采用模板解释器进行逐行解释；运行时数据区用于存放Java运行过程中的各种数据及结构；本地方法接口用于在Java程序内调用本地方法

![JVM架构](imgs\JVM\1.png)

:point_right:**讲一下运行时数据区？**

> 规范划分为**五个**区域

运行时数据区用于存放Java程序运行过程中的各种数据及数据结构，主要包括堆、虚拟机栈、本地方法栈、程序计数器以及方法区这几个组成部分

- 堆是线程共享的区域，主要用于存放Java中的各种实例对象，创建新对象的内存都是在堆上分配的

- 虚拟机栈是线程私有的，主要用于方法的调用，每次方法调用，对应产生一个虚拟机栈中的栈帧，一个栈桢包括局部变量表、操作数栈、动态链接、方法返回地址

- 本地方法栈是线程私有的，对应线程中调用的本地方法，在hotspot中与虚拟机栈合二为一

- 程序计数器是线程私有的，用于存储程序运行时下一条指令的地址，程序的分支、循环、跳转、异常跳转等功能都是靠它实现，字节码解释器通过修改程序计数器的值来选取下一条需要执行的指令（根据指令类型不同有所不同，可以在取指阶段计算长度就能知道，也可能是需要根据指令内容来计算）
- 方法区是线程共享的，主要用于存放各种元信息，包括类元信息、方法信息、CodeCache及运行时常量池等

:point_right:**为什么pc寄存器要线程私有？**

PC寄存器需要保存线程执行到哪一条指令了，线程在执行过程中可能由于时间片轮转把cpu让给其他线程而暂停执行，恢复执行的时候需要从上次执行到的位置继续往下执行，如果这一区域共享了，就不容易保存上次运行到的位置了，线程之间会互相干扰

:point_right:**堆栈的区别？**

- 内存：堆的内存不是连续分配的，栈的内存是连续分配的
- 线程共享/私有：堆是共享的，栈是私有的
- 抛出异常：堆抛出OOM异常；不支持栈动态扩展的话，栈深度超过某一阈值会报SOF，支持的话则可能由于内存不足报OOM

:point_right:**对象实例化过程？**

> 6个步骤

调用new方法在堆中创建一个对象，① 首先会检查类是否加载完成，没有的话则进行类的加载。② 接着会在堆上分配内存，如果内存是规整的，即是通过标记压缩算法整理的，则采用指针碰撞法来分配内存；否则通过空闲列表法分配内存。③ 在分配内存时也要考虑并发问题，首选通过TLAB给每个线程分配私有的缓冲区，在缓冲区上分配，分配失败后可以通过CAS来避免冲突。④ 接着会对分配到的空间进行初始化，主要是给成员变量赋零值等。⑤ 然后设置对象头。⑥ 最后调用\<init>初始化，包括显式初始化、代码块初始化、构造器初始化等

:point_right:**知道句柄访问吗？**

知道。hotspot中采用的是直接访问，栈中的引用指向堆中的实例对象地址，实例对象头中的klass pointer指向方法区的类元信息，如果发生GC对对象进行移动，栈中引用指向的地址也要随之改变，但速度快，能够一次访问到对象。而句柄访问是在堆中句柄池中创建一个句柄，包括一个指向实例对象地址的指针和一个指向类元信息的指针，并令栈中的引用指向这个句柄地址；GC移动对象后，只需要改变句柄中指向实例对象的指针，而不需要去改变栈中的引用，缺点是要消耗更多空间，并且访问对象时要多一次步骤

<img src="imgs\JVM\3.png" alt="image-20210822223548563" style="zoom:33%;" />

:point_right:**java内存泄漏的场景？**

长生命周期对象持有短生命周期对象的引用，导致短生命周期对象迟迟不能被回收，这就是内存泄漏。典型场景有threadlocal，如果不作清空操作，线程中一直有一个以null为键的Entry迟迟不能被回收，线程持续多久这个Entry就要持续多久

## 类加载

:point_right:**java类加载过程？**

java类加载包括三个步骤，类的装载、链接和初始化。其中装载是将二进制Class文件或动态生成的字节码加载到内存当中，将静态结构转换成内存中运行的数据结构，并且在堆中生成一个对应的Class对象。链接包括验证、准备和解析，验证阶段会对字节码的合法性进行校验，包括魔数头校验等等；准备阶段会对类变量进行零值初始化，解析阶段会将部分常量池中的符号引用转换成直接引用；初始化阶段会调用\<clinit>方法对类变量进行显式初始化并执行静态代码块



## GC



## 调优





