# [è¿”å›](/)

# Netty

å¼‚æ­¥ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶

åº”ç”¨åœºæ™¯ï¼šRPCæ¡†æ¶ç­‰

# TCPé€šä¿¡åŸºç¡€

## å¼•è¨€

ä»¥ä¸€ä¸ªä¾‹å­å…¥æ‰‹ï¼š

```sh
exec 8<> /dev/tcp/www.baidu.com/80
echo -e "GET / HTTP/1.0\n" 1>& 8
cat 0<& 8
```

é€è¡Œè§£é‡Šï¼š

- `exec 8<> /dev/tcp/www.baidu.com/80`

  - linuxä¸€åˆ‡çš†æ–‡ä»¶ï¼Œ/dev/tcp/www.baidu.com/80çœ‹ä¼¼æ˜¯è·¯å¾„å®åˆ™æ˜¯ä¸€ä¸ªsocketï¼Œç”¨8æŒ‡å‘äº†ä¸€ä¸ªsocketï¼Œ8å°±ç›¸å½“äºä¸€ä¸ªé€šä¿¡çš„channelï¼Œ<>ä»£è¡¨è¾“å…¥è¾“å‡ºæµ

  - 8 â†’ fdï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ç†è§£æˆç±»ä¼¼Javaä¸­çš„å˜é‡å¼•ç”¨

    > [https://www.zhihu.com/search?type=content&q=%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6](https://www.zhihu.com/search?type=content&q=%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6)

  - execï¼šé¦–å…ˆç†è§£ä¸€ä¸‹shellæ˜¯ä»€ä¹ˆï¼Ÿ

    > shellçš„è‹±æ–‡å«ä¹‰æ˜¯â€œå£³â€ï¼›
    >
    > å®ƒæ˜¯ç›¸å¯¹äºå†…æ ¸æ¥è¯´çš„ï¼Œå› ä¸ºå®ƒæ˜¯å»ºç«‹åœ¨å†…æ ¸çš„åŸºç¡€ä¸Šï¼Œé¢å‘äºç”¨æˆ·çš„ä¸€ç§è¡¨ç°å½¢å¼ï¼Œæ¯”å¦‚æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªçƒï¼Œè§åˆ°çš„æ˜¯å®ƒçš„å£³ï¼Œè€Œéæ ¸
    >
    > Linuxä¸­çš„shellï¼Œæ˜¯æŒ‡ä¸€ä¸ªé¢å‘ç”¨æˆ·çš„å‘½ä»¤æ¥å£ï¼Œè¡¨ç°å½¢å¼å°±æ˜¯ä¸€ä¸ªå¯ä»¥ç”±ç”¨æˆ·å½•å…¥çš„ç•Œé¢ï¼Œè¿™ä¸ªç•Œé¢ä¹Ÿå¯ä»¥åé¦ˆè¿è¡Œä¿¡æ¯ï¼›ç›¸å½“äºä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸æ–­readç”¨æˆ·çš„æŒ‡ä»¤å½•å…¥ï¼Œå¹¶è¿”å›ç»“æœ

    - execåé¢æ¥ä¸ŠæŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä¼šæ›¿æ¢æ‰shellï¼Œæ¯”å¦‚exec lså‘½ä»¤ï¼Œlsä¼šæ˜¾ç¤ºç›®å½•åé€€å‡ºï¼Œå¦‚æœç”¨lsæ›¿æ¢shellï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œç”¨æˆ·ä¸ç³»ç»Ÿçš„é“¾æ¥ä¹Ÿå°±æ–­å¼€äº†

      ![image-20211209165351917](imgs\netty\16.png)

    - ä»»ä½•ç¨‹åºéƒ½æœ‰è¾“å…¥è¾“å‡ºæµï¼Œæ¯”å¦‚ls 1>xxx.txtï¼Œ1æ˜¯ä¸€ä¸ªfdï¼Œä»£è¡¨æ ‡å‡†è¾“å‡ºæµï¼Œé€šè¿‡>é‡å®šå‘åˆ°xxx.txt

      ![image-20211209165756780](imgs\netty\17.png)

    - å¯ä»¥é€šè¿‡execç»™å‡ºé‡å®šå‘çš„ç»‘å®šï¼Œè§£é‡Šèµ·æ¥å°±æ˜¯ï¼šå»ºç«‹æ–‡ä»¶æè¿°ç¬¦8ï¼Œå¹¶å°†å®ƒçš„è¾“å…¥è¾“å‡ºæµä¸socketç»‘å®šåˆ°ä¸€èµ·

- `echo -e "GET / HTTP/1.0\n" 1>& 8`

  - 1æ˜¯echoå‘½ä»¤çš„ç»‘å®šæ ‡å‡†è¾“å‡ºæµçš„fd
  - å‘é€ä¸€ä¸ªhttpåè®®å¤´åˆ°8æŒ‡å‘çš„socket
  - \>ï¼šåˆ°æ–‡ä»¶ï¼›>&ï¼šåˆ°å¦ä¸€ä¸ªfd

- `cat 0<& 8`

  - è¾“å…¥åˆ°catçš„fd 0
  - catçš„ä½œç”¨æ˜¯æ‰“å°

æ‰§è¡Œç»“æœï¼š

![image-20211209170735795](imgs\netty\18.png)

## ä»€ä¹ˆæ˜¯TCPåè®®ï¼Ÿ

ä¼ è¾“æ§åˆ¶å±‚çš„**ï¼Œé¢å‘è¿æ¥çš„ï¼Œå¯é çš„ä¼ è¾“åè®®**ï¼ˆä¸¤ä¸ªé‡ç‚¹ï¼‰

### ä»€ä¹ˆæ˜¯é¢å‘è¿æ¥çš„ï¼Ÿ

**ä¸‰æ¬¡æ¡æ‰‹æ¦‚è¿°ï¼š**

![image-20211209172534759](imgs\netty\19.png)

åŒæ–¹ç¡®è®¤å¯¹æ–¹éƒ½èƒ½æ”¶åˆ°åï¼Œä¼šåˆ†åˆ«è‡ªå·±å¼€å¯æœåŠ¡èµ„æºï¼Œç”¨äºå¤„ç†è‡ªå·±åŒ…çš„å‘é€å’Œæ¥æ”¶å¯¹æ–¹çš„åŒ…

**åªæœ‰åœ¨ä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼ŒåŒæ–¹å®Œæˆäº†æœåŠ¡èµ„æºçš„å¼€è¾Ÿï¼Œæ‰å¯ä»¥è¯´è¿æ¥è¢«å»ºç«‹äº†**

è¿™é‡Œçš„è¿æ¥ï¼Œä¸æ˜¯æŒ‡ç‰©ç†çš„ï¼Œè€Œæ˜¯åŒæ–¹æœ‰ç›¸äº’çš„é€šä¿¡ä¿¡é“åŠå¯¹åº”çš„æœåŠ¡èµ„æº

- **ä¸‰æ¬¡æ¡æ‰‹å¸¦æ¥äº†è¿æ¥ï¼Œç¡®è®¤æœºåˆ¶ä¿è¯äº†å¯é çš„ä¼ è¾“**
- ä¸‰æ¬¡æ¡æ‰‹æ˜¯ç”±å››å±‚ï¼ˆTCP/IPäº”å±‚æ¨¡å‹/OSIä¸ƒå±‚æ¨¡å‹ä¸‹é¢å››å±‚ï¼‰å†…æ ¸å®Œæˆçš„ï¼Œæ•°æ®ä¼ è¾“æ˜¯ç”±ä¸ƒå±‚ç”¨æˆ·å®Œæˆçš„

---

**å››æ¬¡æŒ¥æ‰‹æ¦‚è¿°ï¼š**

![image-20211209200639113](imgs\netty\22.png)

åŒæ–¹éƒ½ç¡®è®¤å…³é—­èµ„æºäº†ï¼Œæ‰æ–­å¼€è¿æ¥

### ä»€ä¹ˆæ˜¯socketï¼Ÿ

**socketæ˜¯å¯¹TCP/IPåè®®çš„å°è£…ï¼Œå®ƒçš„å‡ºç°åªæ˜¯ä½¿å¾—ç¨‹åºå‘˜æ›´æ–¹ä¾¿åœ°ä½¿ç”¨TCP/IPåè®®æ ˆè€Œå·²ã€‚socketæœ¬èº«å¹¶ä¸æ˜¯åè®®ï¼Œå®ƒæ˜¯åº”ç”¨å±‚ä¸TCP/IPåè®®æ—é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œæ˜¯ä¸€ç»„è°ƒç”¨æ¥å£ï¼ˆTCP/IPç½‘ç»œçš„APIå‡½æ•°ï¼‰**

socketä¸€å®šæ˜¯æˆå¯¹çš„ï¼šip+portå¯¹åº”å¦ä¸€ä¸ªip+portï¼Œèƒ½å¤Ÿä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„è¿æ¥

![image-20211209173604365](imgs\netty\20.png)

> é¢è¯•é¢˜ï¼š
>
> 1. ipCä¸ºå®¢æˆ·ç«¯ï¼Œå‘ipA:80æœ€å¤šèƒ½å»ºç«‹å¤šå°‘ä¸ªè¿æ¥ï¼Ÿ
>
>    65535ä¸ªï¼Œå®¢æˆ·ç«¯ç«¯å£éšæœºåˆ†é…ï¼ŒèŒƒå›´0~65535ï¼Œ0æ˜¯è¢«ä¿ç•™çš„
>
> 2. ä¸ipA:80å»ºç«‹äº†65535ä¸ªè¿æ¥åï¼Œå¯ä»¥ç»§ç»­å’ŒipB:80å»ºç«‹é“¾æ¥å—ï¼Ÿ
>
>    å¯ä»¥ï¼Œå› ä¸ºä¸€ä¸ªå¥—æ¥å­—æ˜¯ç”±4ä¸ªç»´åº¦æ¥ç¡®å®šçš„

å¯¹äºæœåŠ¡ç«¯çš„22ç«¯å£å·²ç»å»ºç«‹äº†è‹¥å¹²ä¸ªè¿æ¥ï¼Œæœ‰å¦å¤–çš„å®¢æˆ·ç«¯å¸¦ç€æ•°æ®åŒ…è¿‡æ¥ï¼Œç»è¿‡ä¸‰æ¬¡æ¡æ‰‹åï¼ŒæœåŠ¡ç«¯å¼€è¾Ÿèµ„æºå¹¶forkè¿›ç¨‹/çº¿ç¨‹ï¼Œä»¤ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹/çº¿ç¨‹æŒæœ‰è¯¥socketï¼ˆé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥å”¯ä¸€æ ‡è¯†ï¼Œæ¯”å¦‚ä¸Šé¢é‚£ä¸ªä¾‹å­ä¸­çš„â€œ8â€ï¼‰

> å¤šä¸ªsocketå¯¹åº”ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼šå¤šè·¯å¤ç”¨ï¼ˆselect/epollï¼‰

### æŠ“åŒ…éªŒè¯

å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¿è¡Œ`tcpdump -nn (åŠ -Xå¯ä»¥æ‰“å°å‡ºè¯¦ç»†çš„æŠ“åˆ°çš„æ•°æ®) -i eth0 port 80`æŠ“åŒ…

æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¿è¡Œ`curl www.baidu.com`

![image-20211209195727445](imgs\netty\21.png)

- ç¬¬ä¸€æ®µä¸ºä¸‰æ¬¡æ¡æ‰‹ï¼Œæ•°æ®åŒ…å¤§å°ä¸º0
- ç¬¬äºŒæ®µä¸ºæ•°æ®ä¼ è¾“ï¼Œéšæœºåˆ†é…çš„57300ç«¯å£å’Œç™¾åº¦80ç«¯å£ä¹‹é—´äº’ç›¸é€šä¿¡ï¼Œæ³¨æ„å‘é€å’Œç¡®è®¤æœºåˆ¶
- ç¬¬ä¸‰æ®µä¸ºå››æ¬¡æŒ¥æ‰‹ï¼Œæ•°æ®åŒ…å¤§å°ä¸º0

## ç½‘ç»œé€šä¿¡æµç¨‹ç®€è¿°

> [https://blog.csdn.net/Stephen___Qin/article/details/120466415](https://blog.csdn.net/Stephen___Qin/article/details/120466415)
>
> [https://blog.csdn.net/weixin_44786530/article/details/89382641](https://blog.csdn.net/weixin_44786530/article/details/89382641)

![img](imgs\netty\23.png)

ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´ï¼Œä¸€ä¸ªHTTPæ•°æ®åŒ…æƒ³è¦å‘é€ç»™ç™¾åº¦

> æŸ¥çœ‹æœ¬æœºç½‘å¡ï¼š`vi /etc/sysconfig/network-scripts/ifcfg-enp0s3 `
>
> ![image-20211209212605473](imgs\netty\24.png)
>
> dhcpéšæœºåˆ†é…ip

æŸ¥çœ‹æœ¬æœºIPï¼š`ifconfig`

![image-20211209212828680](imgs\netty\25.png)

æŸ¥çœ‹ç™¾åº¦IPï¼š`ping`

![image-20211209213314405](imgs\netty\26.png)

ä¹Ÿå°±æ˜¯è¯´ï¼šä»192.168.199.66æŸä¸ªç«¯å£å‘110.242.68.3æŸä¸ªç«¯å£è¿›è¡Œé€šä¿¡

> ä¸€ä¸ªipåœ°å€ï¼Œæ©ç è¦†ç›–çš„èŒƒå›´ä¸ºç½‘ç»œéƒ¨åˆ†ï¼Œå‰©ä¸‹ä¸ºä¸»æœºéƒ¨åˆ†

- é¦–å…ˆï¼Œå°†HTTPæ•°æ®åŒ…å°è£…æˆTCPæ•°æ®åŒ…ï¼Œå‡†å¤‡å‘ç›®æ ‡ä¸»æœºç«¯å£å‘é€

- ä¼ è¾“TCPæ•°æ®åŒ…éœ€è¦ç»è¿‡ç½‘ç»œå±‚ï¼Œå°è£…æˆIPæ•°æ®åŒ…å¹¶è½¬å‘

  åœ¨è·¯ç”±è¡¨ä¸­ï¼Œå°†ç›®æ ‡åœ°å€ä¸æ¯ä¸€æ¡çš„æ©ç ç›¸ä¸æ±‚å‡ºç½‘ç»œéƒ¨åˆ†ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½ä¸DestinationåŒ¹é…

  ![image-20211209214006461](D:\ç¬”è®°\ç§‹æ‹›\docs\æ¡†æ¶\imgs\netty\27.png)

  â€‹	ç›®æ ‡åœ°å€ä¸º110.242.68.3ï¼Œç›¸ä¸ç»“æœä¸ºï¼š

  â€‹	â‘  0.0.0.0ï¼›â‘¡ 110.242.0.0ï¼›â‘¢ 110.242.68.0ï¼›â‘£ 110.242.68.0

  åªæœ‰ç¬¬ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…ï¼Œäºæ˜¯å‘é€ç»™Gateway 192.168.199.1è½¬å‘ï¼Œ192.168.199.1å†ç»å†ç›¸åŒè¿‡ç¨‹å‘ä¸‹ä¸€ä¸ªè·¯ç”±èŠ‚ç‚¹è½¬å‘

- è®¾æƒ³ä¸€ä¸‹ï¼šè·¯ç”±èŠ‚ç‚¹è½¬å‘è¿‡ç¨‹ä¸­ï¼Œç›®æ ‡IPï¼ˆ110.242.68.3ï¼‰ä¸æœ¬æœºåŒ¹é…ä¸ä¸Šï¼Œä¸ºä»€ä¹ˆä¸ä¼šé€‰æ‹©ä¸¢åŒ…è€Œæ˜¯ç»§ç»­è½¬å‘å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°é“¾è·¯å±‚ARPåè®®äº†

  - åœ¨è·¯ç”±è½¬å‘è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¼šæ ¹æ®ä¸‹ä¸€è·³èŠ‚ç‚¹çš„IPï¼Œè¯·æ±‚å¯¹åº”ä¸»æœºè¿”å›è‡ªå·±çš„MACåœ°å€ï¼Œå­˜åœ¨æœ¬æœºARPåˆ—è¡¨

    ![image-20211209215456612](imgs\netty\29.png)

  - æ ¹æ®ARPåˆ—è¡¨ï¼Œå‘ç°å¯¹åº”çš„MACä¸º34:96:72:1c:fa:3eï¼Œå°†IPæ•°æ®åŒ…å°è£…æˆMACæ•°æ®åŒ…ï¼Œå‘é€åˆ°ä¸»æœº192.168.199.1

  - 192.168.199.1å‘ç°MACåŒ…å°±æ˜¯è‡ªå·±çš„åœ°å€ï¼Œä½†IPä¸åŒ¹é…ï¼Œäºæ˜¯éœ€è¦ç»§ç»­è½¬å‘ï¼Œå°†MACå¤´æ¸…é™¤ï¼Œå¹¶æ ¹æ®ARPåˆ—è¡¨å°è£…ä¸‹ä¸€è·³çš„MACåœ°å€

  - å‘é€ç»™ç‰©ç†å±‚è¿›è¡Œä¼ è¾“

- è‹¥å¹²è·³ä¹‹åï¼Œç»ˆäºåˆ°è¾¾ç™¾åº¦ï¼Œå‘ç°IPåŒ¹é…ï¼Œæ‹†å°ï¼Œæ ¹æ®ç›®æ ‡ç«¯å£å·åœ¨å¯¹åº”ç«¯å£å·ä¸Šå¼€è¾ŸæœåŠ¡èµ„æº

> åŒä¸€ç½‘æ®µä¸‹çš„ä¸»æœºï¼Œè·¯ç”±è¡¨å¯¹åº”çš„æ©ç ä¸º255.255.255.0ï¼Œgatewayä¸º0.0.0.0ï¼Œè¡¨ç¤ºä¸ç”¨åˆ©ç”¨ç½‘å…³è¿›è¡Œè½¬å‘ï¼Œåªéœ€è¦é€šè¿‡é“¾è·¯å±‚äº¤æ¢æœºå³å¯

> å†…ç½‘æ•°æ®ä¼ è¾“ï¼šä¸»æœº â†’ äº¤æ¢æœºï¼ˆLANå£ï¼‰ â†’ ä¸»æœº
>
> å¤–ç½‘æ•°æ®ä¼ è¾“ï¼šä¸»æœº â†’ äº¤æ¢æœº â†’ è·¯ç”±å™¨ï¼ˆWANå£ï¼‰ â†’ è‹¥å¹²ä¸ªè·¯ç”±å™¨ â†’ äº¤æ¢æœº â†’ ä¸»æœº
>
> ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œç›®æ ‡IPä¸å˜ï¼ŒMACåœ°å€ä¸æ–­å˜åŒ–

> VPNä¼ è¾“ï¼šIPæ•°æ®åŒ…é‡Œé¢å†åŒ…ä¸€ä¸ªåŠ å¯†çš„IPæ•°æ®åŒ…ï¼Œå¤–é¢çš„åˆ°é¦™æ¸¯ï¼Œé‡Œé¢çš„åˆ°ç¾å›½ï¼ˆä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼‰

# IOæ¨¡å‹

## ä¸€äº›æ¦‚å¿µ

åœ¨ç¼–å†™æœåŠ¡å™¨ç«¯ç½‘ç»œç¨‹åºæ—¶ï¼Œæˆ‘ä»¬æœ€å¸¸è§åˆ°é˜»å¡ã€éé˜»å¡ã€åŒæ­¥å’Œå¼‚æ­¥è¿™å››ä¸ªè¯ã€‚å®ƒä»¬çš„è§£é‡Šåˆ†åˆ«å¦‚ä¸‹ï¼š

- é˜»å¡ï¼š é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨è¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œåªæœ‰å½“è°ƒç”¨å¾—åˆ°ç»“æœåæ‰è¿”å›
- éé˜»å¡ï¼šä¸é˜»å¡ç›¸åï¼Œéé˜»å¡è°ƒç”¨æ˜¯æŒ‡åœ¨ä¸èƒ½ç«‹å³å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šå°†å½“å‰çº¿ç¨‹é˜»å¡ï¼Œè€Œæ˜¯ç«‹å³è¿”å›
- åŒæ­¥ï¼šæ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªåŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨å°±ä¸è¿”å›ã€‚ç­‰å‰ä¸€ä»¶åšå®Œäº†æ‰èƒ½åšä¸‹ä¸€ä»¶äº‹
- å¼‚æ­¥ï¼šå¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…

> é˜»å¡å¯ä»¥æ˜¯å®ç°åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼›ä¾‹å¦‚ä¸¤ä¸ªä¸œè¥¿éœ€è¦åŒæ­¥ï¼Œä¸€æ—¦å‡ºç°ä¸åŒæ­¥æƒ…å†µï¼Œæˆ‘å°±é˜»å¡å¿«çš„ä¸€æ–¹ï¼Œä½¿åŒæ–¹è¾¾åˆ°åŒæ­¥
>
> åŒæ­¥æ˜¯ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè€Œé˜»å¡æ˜¯ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€
>
> **é˜»å¡éé˜»å¡çš„åˆ’åˆ†æ ‡å‡†æ˜¯â€œè°ƒç”¨è€…æ˜¯å¦éœ€è¦ä¸€ç›´é˜»å¡ç­‰å¾…IOæ“ä½œå°±ç»ªâ€**
>
> **åŒæ­¥å¼‚æ­¥çš„åˆ’åˆ†æ ‡å‡†æ˜¯â€œè°ƒç”¨è€…æ˜¯å¦éœ€è¦ç­‰å¾…I/Oæ“ä½œå®Œæˆâ€**

## äº”ç§ IO æ¨¡å‹

æœåŠ¡å™¨ç«¯ IO ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼šç£ç›˜ IO å’Œç½‘ç»œ IOï¼Œåœ¨è®²æœåŠ¡å™¨ç«¯é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ—¶æ›´å¤šæ—¶å€™æˆ‘ä»¬è®²çš„æ˜¯ç½‘ç»œ IO æ¨¡å‹ã€‚ä¸€æ¬¡å®Œæ•´çš„æœåŠ¡å™¨ç«¯å¤„ç†ç½‘ç»œè¯·æ±‚æµç¨‹å›¾å¦‚ä¸‹ï¼ˆç®€åŒ–ç‰ˆï¼Œä»¥ Web æœåŠ¡å™¨ä¸ºä¾‹ï¼‰ï¼š

![img](imgs\netty\1.png)



å®¢æˆ·ç«¯è¯·æ±‚æ•°æ® â†’ ç½‘å¡ â†’ å†…æ ¸ç©ºé—´ â†’ ç”¨æˆ·ç©ºé—´

ç”¨æˆ·å¤„ç†åçš„æ•°æ® â†’ å†…æ ¸ç©ºé—´ â†’ ç½‘å¡ â†’ è¿”å›ç»™å®¢æˆ·ç«¯

### 1ã€é˜»å¡ IO æ¨¡å‹ï¼ˆblocking IOï¼‰

![img](imgs\netty\2.png)

åº”ç”¨ç¨‹åºè¿›è¡Œ recvfrom ç³»ç»Ÿè°ƒç”¨æ—¶å°†é˜»å¡åœ¨æ­¤è°ƒç”¨ï¼Œç›´åˆ°è¯¥å¥—æ¥å­—ä¸Šæœ‰æ•°æ®å¹¶ä¸”å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºã€‚è¯¥æ¨¡å¼ä¸€èˆ¬é…åˆå¤šçº¿ç¨‹ä½¿ç”¨ï¼Œåº”ç”¨è¿›ç¨‹æ¯æ¥æ”¶ä¸€ä¸ªè¿æ¥ï¼Œä¸ºæ­¤è¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¯¥è¿æ¥ä¸Šçš„è¯»å†™ä»¥åŠä¸šåŠ¡å¤„ç†

- ä¼˜ç‚¹ï¼šå®ç°ç®€å•
- ç¼ºç‚¹ï¼šå¦‚æœå¥—æ¥å­—ä¸Šæ²¡æœ‰æ•°æ®ï¼Œè¿›ç¨‹å°†ä¸€ç›´é˜»å¡ã€‚è¿™æ—¶å…¶ä»–å¥—æ¥å­—ä¸Šæœ‰æ•°æ®ä¹Ÿä¸èƒ½è¿›è¡ŒåŠæ—¶å¤„ç†ã€‚å¦‚æœæ˜¯å¤šçº¿ç¨‹æ–¹å¼ï¼Œé™¤éè¿æ¥å…³é—­å¦åˆ™çº¿ç¨‹ä¼šä¸€ç›´å­˜åœ¨ä¸”é˜»å¡ï¼Œè€Œçº¿ç¨‹çš„åˆ›å»ºã€ç»´æŠ¤å’Œé”€æ¯éå¸¸æ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥èƒ½å»ºç«‹çš„è¿æ¥æ•°é‡éå¸¸æœ‰é™

#### ç¼–ç¨‹å®ç°

1. æœåŠ¡ç«¯å»ºç«‹ä¸€ä¸ªServerSocket*ï¼ˆSocketï¼Œåº”ç”¨å±‚ä¸ä¼ è¾“å±‚ä¹‹é—´çš„æŠ½è±¡å±‚ï¼Œå‘åº”ç”¨ç¨‹åºæä¾›ä¸€å¥—ä½¿ç”¨TCPç­‰é€šä¿¡åè®®é€šä¿¡çš„ç®€å•æ¥å£ï¼‰*
2. å®¢æˆ·ç«¯å»ºç«‹Sokcetå¯¹æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œé»˜è®¤æƒ…å†µä¸‹æœåŠ¡ç«¯è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹ä¸€ä¸ªé€šä¿¡çº¿ç¨‹
3. å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚åï¼Œå…ˆå’¨è¯¢æœåŠ¡ç«¯æ˜¯å¦æœ‰çº¿ç¨‹å“åº”
   - æ²¡æœ‰ï¼Œåˆ™ç­‰å¾…ï¼Œæˆ–æ‹’ç»
   - æœ‰ï¼Œåˆ™å®¢æˆ·ç«¯é˜»å¡ç­‰å¾…åˆ°è¯·æ±‚å®Œæˆåï¼Œå†æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ

**æœåŠ¡ç«¯ï¼š**

- æ—§IOå®ç°ï¼š

```java
/**
 *  @ClassName: BIOServer
 *  @Description:
 *  @Author: 747591245@qq.com
 *  @Date: 2021/12/6
 */
public class BIOServer {
    public static void main(String[] args) throws IOException {
        ExecutorService service = Executors.newFixedThreadPool(10);
        ServerSocket serverSocket = new ServerSocket(6666);
        while (true){
            System.out.println("å½“å‰çº¿ç¨‹æ•°: " + ((ThreadPoolExecutor) service).getActiveCount());
            final Socket accept = serverSocket.accept();
            service.execute(new Runnable() {
                @Override
                public void run() {
                    handler(accept);
                }
            });
        }
    }
    public static void handler(Socket socket){
        try (InputStream inputStream = socket.getInputStream()){
            byte[] bytes = new byte[1024];
            while (true){
                int read = inputStream.read(bytes);
                if (read != -1){
                    System.out.println(new String(bytes, 0, read));
                }else {
                    break;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

- Java NIOå®ç°ç‰ˆï¼š

```java
/**
 *  @ClassName: BIOServer
 *  @Description:
 *  @Author: 747591245@qq.com
 *  @Date: 2021/12/6
 */
public class BIOServer {
    public static void main(String[] args) throws IOException {
        ExecutorService service = Executors.newFixedThreadPool(10);
        ServerSocketChannel ss = ServerSocketChannel.open();
        ss.bind(new InetSocketAddress(6666));
        while (true){
            System.out.println("å½“å‰çº¿ç¨‹æ•°: " + ((ThreadPoolExecutor) service).getActiveCount());
            final SocketChannel accept = ss.accept();
            service.execute(new Runnable() {
                @Override
                public void run() {
                    handler(accept);
                }
            });
        }
    }
    public static void handler(SocketChannel socket){
        try (socket){
            ByteBuffer bytes = ByteBuffer.allocate(1024);
            while (true){
                int read = socket.read(bytes);
                if (read != -1){
                    System.out.println(new String(bytes.array(), 0, read));
                }else {
                    break;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

**å®¢æˆ·ç«¯åˆ©ç”¨telnetå»ºç«‹è¿æ¥ï¼š**

```sh
telnet 127.0.0.1 6666
```

![image-20211206205206839](imgs\netty\8.png)

æ¯æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹

å¤§å¹¶å‘éœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œæ¶ˆè€—èµ„æºï¼›readè¯»ä¸åˆ°æ•°æ®ä¼šé˜»å¡ï¼Œé€ æˆç³»ç»Ÿèµ„æºçš„æµªè´¹

### 2ã€éé˜»å¡ IO æ¨¡å‹ï¼ˆnonblocking IOï¼‰

![img](imgs\netty\3.png)

åº”ç”¨è¿›ç¨‹æ¯æ¬¡è°ƒç”¨ recvfrom å³ä½¿æ²¡æœ‰æ•°æ®å‡†å¤‡å¥½ä¹Ÿä¸ä¼šé˜»å¡ï¼Œä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé¿å…äº†è¿›ç¨‹é˜»å¡åœ¨æŸä¸ªè¿æ¥ä¸Šçš„å¼Šç«¯

- ä¼˜ç‚¹ï¼šä»£ç ç¼–å†™ç›¸å¯¹ç®€å•ï¼Œè¿›ç¨‹ä¸ä¼šé˜»å¡ï¼Œå¯ä»¥åœ¨åŒä¸€çº¿ç¨‹ä¸­å¤„ç†æ‰€æœ‰è¿æ¥
- ç¼ºç‚¹ï¼šéœ€è¦é¢‘ç¹çš„è½®è¯¢ï¼Œæ¯”è¾ƒè€—CPUï¼Œåœ¨å¹¶å‘é‡å¾ˆå¤§çš„æ—¶å€™å°†èŠ±è´¹å¤§é‡æ—¶é—´åœ¨æ²¡æœ‰ä»»ä½•æ•°æ®çš„è¿æ¥ä¸Šè½®è¯¢ï¼Œä¸”æ¯æ¬¡è½®è¯¢æ‰€æœ‰channelï¼Œè°ƒç”¨recvï¼Œä¼šäº§ç”Ÿç›¸åº”æ¬¡æ•°çš„è½¯ä¸­æ–­ï¼Œå‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œå¼€é”€å¾ˆå¤§ã€‚æ‰€ä»¥è¯¥æ¨¡å‹åªåœ¨ä¸“é—¨æä¾›æŸç§åŠŸèƒ½çš„ç³»ç»Ÿä¸­æ‰ä¼šå‡ºç°

#### ç¼–ç¨‹å®ç°

```java
ServerSocketChannel ss = ServerSocketChannel.open();
ss.bind(new InetSocketAddress(6666));
ss.configureBlocking(false);
List<SocketChannel> channels = new LinkedList<>();
while (true){
    final SocketChannel accept = ss.accept();
    if (accept != null){
        accept.configureBlocking(false);
        channels.add(accept);
    }
    for (SocketChannel channel: channels){
        ByteBuffer bytes = ByteBuffer.allocate(1024);
        bytes.clear();
        int read = channel.read(bytes);
        if (read > 0){
            System.out.println(new String(bytes.array(), 0, read));
        }
    }
}
```

æ”¹æˆéé˜»å¡æ¨¡å¼ï¼Œä¸€ä¸ªä¸»çº¿ç¨‹å°±å¯ä»¥å¤„ç†å¤šä¸ªIO

![image-20211210014721230](imgs\netty\31.png)

è®¾æƒ³ä¸€ä¸‹ï¼Œæ¯æ¬¡éœ€è¦è½®è¯¢æ‰€æœ‰çš„channelï¼Œå‡å¦‚æœ‰10000ä¸ªè¿æ¥ï¼Œå°±éœ€è¦è½®è¯¢10000æ¬¡ï¼Œè¿›è¡Œ10000æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå¼€é”€éå¸¸å¤§ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªchannelæœ‰æ•ˆï¼Œåˆ™å…¶ä»–9999æ¬¡éƒ½æ˜¯æµªè´¹çš„ã€‚æœ‰ä¸€ç§æ–¹æ³•ï¼Œèƒ½å¤Ÿé’ˆå¯¹æœ‰æ•ˆçš„channelè¿›è¡Œä¸€æ¬¡recvç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åé’ˆå¯¹å…¶ä»–æ‰€æœ‰çš„9999ä¸ªchannelï¼Œåªå‘èµ·ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæ€»å…±åªæœ‰ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ï¼Œå°±æ˜¯**å¤šè·¯å¤ç”¨**

### 3ã€IO å¤ç”¨æ¨¡å‹ï¼ˆIO multiplexingï¼‰

![img](imgs\netty\4.png)

åº”ç”¨è¿›ç¨‹é˜»å¡äº select/poll/epoll ç­‰ç³»ç»Ÿå‡½æ•°ç­‰å¾…æŸä¸ªè¿æ¥å˜æˆå¯è¯»ï¼ˆæœ‰æ•°æ®è¿‡æ¥ï¼‰ï¼Œå†è°ƒç”¨ recvfrom ä»è¿æ¥ä¸Šè¯»å–æ•°æ®ã€‚è™½ç„¶æ­¤æ¨¡å¼ä¹Ÿä¼šé˜»å¡åœ¨ select/poll/epoll ä¸Šï¼Œä½†ä¸é˜»å¡IO æ¨¡å‹ä¸åŒå®ƒé˜»å¡åœ¨ç­‰å¾…å¤šä¸ªè¿æ¥ä¸Šæœ‰è¯»ï¼ˆå†™ï¼‰äº‹ä»¶çš„å‘ç”Ÿï¼Œæ˜æ˜¾æé«˜äº†æ•ˆç‡ä¸”å¢åŠ äº†å•çº¿ç¨‹/å•è¿›ç¨‹ä¸­å¹¶è¡Œå¤„ç†å¤šè¿æ¥çš„å¯èƒ½

- ä¼˜ç‚¹ï¼šç»Ÿä¸€ç®¡ç†è¿æ¥ï¼Œä¸ä¸€å®šé‡‡ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦è½®è¯¢ã€‚åªéœ€è¦é˜»å¡äº select å³å¯ï¼Œå¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªè¿æ¥
- ç¼ºç‚¹ï¼šå½“ select/poll/epoll ç®¡ç†çš„è¿æ¥æ•°è¿‡å°‘æ—¶ï¼Œè¿™ç§æ¨¡å‹å°†é€€åŒ–æˆé˜»å¡ IO æ¨¡å‹ã€‚å¹¶ä¸”è¿˜å¤šäº†ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼šä¸€æ¬¡ select/poll/epoll ä¸€æ¬¡ recvfrom

### 4ã€ä¿¡å·é©±åŠ¨ IO æ¨¡å‹ï¼ˆsignal-driven IOï¼‰

![img](imgs\netty\5.png)

åº”ç”¨è¿›ç¨‹åˆ›å»º SIGIO ä¿¡å·å¤„ç†ç¨‹åºï¼Œæ­¤ç¨‹åºå¯å¤„ç†è¿æ¥ä¸Šæ•°æ®çš„è¯»å†™å’Œä¸šåŠ¡å¤„ç†ã€‚å¹¶å‘æ“ä½œç³»ç»Ÿå®‰è£…æ­¤ä¿¡å·ï¼Œè¿›ç¨‹å¯ä»¥å¾€ä¸‹æ‰§è¡Œã€‚å½“å†…æ ¸æ•°æ®å‡†å¤‡å¥½ä¼šå‘åº”ç”¨è¿›ç¨‹å‘é€ä¿¡å·ï¼Œè§¦å‘ä¿¡å·å¤„ç†ç¨‹åºçš„æ‰§è¡Œã€‚å†åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è¿›è¡Œ recvfrom å’Œä¸šåŠ¡å¤„ç†

- ä¼˜ç‚¹ï¼šéé˜»å¡
- ç¼ºç‚¹ï¼šåœ¨å‰ä¸€ä¸ªé€šçŸ¥ä¿¡å·æ²¡è¢«å¤„ç†çš„æƒ…å†µä¸‹ï¼Œåä¸€ä¸ªä¿¡å·æ¥äº†ä¹Ÿä¸èƒ½è¢«å¤„ç†ã€‚æ‰€ä»¥åœ¨ä¿¡å·é‡å¤§çš„æ—¶å€™ä¼šå¯¼è‡´åé¢çš„ä¿¡å·ä¸èƒ½è¢«åŠæ—¶æ„ŸçŸ¥

### 5ã€å¼‚æ­¥ IO æ¨¡å‹ï¼ˆasynchronous IOï¼‰

![img](imgs\netty\6.png)

åº”ç”¨è¿›ç¨‹é€šè¿‡ aio_read å‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªæ“ä½œï¼Œå¹¶ä¸”åœ¨æ•´ä¸ªæ“ä½œå®Œæˆä¹‹åå†é€šçŸ¥åº”ç”¨è¿›ç¨‹ï¼ŒåŒ…æ‹¬æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚ä¿¡å·é©±åŠ¨ IO æ˜¯å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¯ä»¥å¯åŠ¨ä¸€ä¸ª IO æ“ä½œï¼Œè€Œå¼‚æ­¥ IO æ¨¡å‹æ˜¯ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬ IO æ“ä½œä½•æ—¶å®Œæˆ

> æ³¨ï¼šå‰ 4 ç§æ¨¡å‹éƒ½æ˜¯å¸¦æœ‰é˜»å¡éƒ¨åˆ†çš„ï¼Œæœ‰çš„é˜»å¡åœ¨ç­‰å¾…æ•°æ®å‡†å¤‡å¥½ï¼Œæœ‰çš„é˜»å¡åœ¨ä»å†…æ ¸ç©ºé—´æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ã€‚è€Œè¿™ç§æ¨¡å‹åº”ç”¨è¿›ç¨‹ä»è°ƒç”¨ aio_read åˆ°æ•°æ®è¢«æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¸ç”¨ä»»ä½•é˜»å¡ï¼Œæ‰€ä»¥è¯¥ç§æ¨¡å¼å«å¼‚æ­¥ IO æ¨¡å‹

- ä¼˜ç‚¹ï¼šæ²¡æœ‰ä»»ä½•é˜»å¡ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿå†…æ ¸å°† IO æ“ä½œä¸è®¡ç®—é€»è¾‘å¹¶è¡Œ
- ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚ã€æ“ä½œç³»ç»Ÿæ”¯æŒä¸å¥½ã€‚ç›®å‰åªæœ‰ windows ä¸‹çš„ iocp å®ç°äº†çœŸæ­£çš„ AIOã€‚linux ä¸‹åœ¨ 2.6 ç‰ˆæœ¬ä¸­æ‰å¼•å…¥ï¼Œç›®å‰å¹¶ä¸å®Œå–„ï¼Œæ‰€ä»¥ Linux ä¸‹ä¸€èˆ¬é‡‡ç”¨å¤šè·¯å¤ç”¨æ¨¡å‹

## å„ IO æ¨¡å‹å¯¹æ¯”

å‰å››ç§æ¨¡å‹çš„ä¸»è¦åŒºåˆ«äºç¬¬ä¸€é˜¶æ®µï¼Œå› ä¸ºä»–ä»¬çš„ç¬¬äºŒé˜¶æ®µéƒ½æ˜¯ä¸€æ ·çš„ï¼šåœ¨æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒºæœŸé—´ï¼Œè¿›ç¨‹é˜»å¡äº recvfrom è°ƒç”¨ã€‚ç›¸åï¼Œå¼‚æ­¥ IO æ¨¡å‹åœ¨è¿™ä¸¤ä¸ªé˜¶æ®µéƒ½éœ€è¦å¤„ç†ï¼Œä»è€Œä¸åŒäºå…¶ä»–å››ç§æ¨¡å‹

![img](imgs\netty\7.png)

# æ“ä½œç³»ç»Ÿä¸­çš„SELECT/POLL/EPOLL

> :star2:è¿™é‡Œæœ‰ä¸€ä¸ªå†™å¾—å¾ˆæ¸…æ™°æ˜“æ‡‚çš„åšå®¢ï¼š[https://blog.csdn.net/wangwei19871103/article/details/104080859](https://blog.csdn.net/wangwei19871103/article/details/104080859)
>
> :star:æºç çº§è§£æï¼š[https://www.cnblogs.com/Anker/p/3265058.html](https://www.cnblogs.com/Anker/p/3265058.html)
>
> :star::star:æºç çº§è§£æï¼š[https://www.cnblogs.com/200911/p/7016843.html](https://www.cnblogs.com/200911/p/7016843.html)

è®¾æƒ³ä¸€ä¸‹ï¼Œåœ¨NIOæ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡éœ€è¦è½®è¯¢æ‰€æœ‰çš„channelï¼Œå‡å¦‚æœ‰10000ä¸ªè¿æ¥ï¼Œå°±éœ€è¦è½®è¯¢10000æ¬¡ï¼Œè¿›è¡Œ10000æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå¼€é”€éå¸¸å¤§ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªchannelæœ‰æ•ˆï¼Œå…¶ä»–9999æ¬¡éƒ½æ˜¯æµªè´¹çš„ã€‚èƒ½ä¸èƒ½æœ‰ä¸€ç§æ–¹æ³•ï¼Œé’ˆå¯¹æœ‰æ•ˆçš„channelè¿›è¡Œä¸€æ¬¡recvç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åé’ˆå¯¹å…¶ä»–æ‰€æœ‰çš„9999ä¸ªchannelï¼Œåªå‘èµ·ä¸€æ¬¡å†…æ ¸ç³»ç»Ÿè°ƒç”¨ï¼Œæ€»å…±åªæœ‰ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ï¼Œå°±æ˜¯**å¤šè·¯å¤ç”¨**

å†…æ ¸æä¾›selectã€pollã€epollå®ç°å¤šè·¯å¤ç”¨

## select

**åŒæ­¥çš„IOå¤šè·¯å¤ç”¨å™¨**

### ç»†èŠ‚

`man (2) select`ï¼šï¼ˆ2è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨ï¼Œå¯ç”¨`man man`æŸ¥çœ‹ï¼‰

![image-20211210030513430](imgs\netty\32.png)

> - nfdsï¼šæ‰€æœ‰å·²æ³¨å†Œçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ + 1
>
>   éå†å°äºè¯¥å€¼çš„å€¼ï¼Œå°±èƒ½éå†åˆ°æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚ä¼šä¸€æ¬¡æ€§å°†æ–‡ä»¶æè¿°ç¬¦ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€
>
> - å¯è¯»é›†åˆ
>
>   fd_setå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªä½å›¾ï¼Œå†…æ ¸éå†è¿‡ç¨‹ä¸­å‘ç°æŸä¸€socketå‘ç”Ÿäº†äº‹ä»¶ï¼Œå‡å®šä¸ºè¯»äº‹ä»¶ï¼Œå°±æ ¹æ®å®ƒçš„æ–‡ä»¶æè¿°ç¬¦æ˜ å°„åˆ°readfdsçš„æŸä¸€ä½ï¼Œå°†è¯¥ä½ ç½®ä¸º1
>
> - å¯å†™é›†åˆ
>
> - å¼‚å¸¸é›†åˆ
>
> - è¶…æ—¶æ—¶é—´

- å…è®¸ä¸€ä¸ªç¨‹åºç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œselect**è¿”å›æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€**ï¼ŒçœŸæ­£IOè°ƒç”¨è¿˜éœ€è¦é€šè¿‡ç¨‹åºä½¿ç”¨recvç­‰æŒ‡ä»¤

- **å¦‚æœç¨‹åºè‡ªå·±è¯»å–IOï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯åŒæ­¥çš„**

- selecté™åˆ¶1024ä¸ªæ–‡ä»¶æè¿°ç¬¦

- ç”¨æˆ·ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦äº¤ç»™å†…æ ¸ï¼Œç”±å†…æ ¸å»éå†å¹¶è¿”å›çŠ¶æ€ï¼Œ**åªéœ€ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨**ï¼Œè€ŒéNIOä¸­ï¼Œéœ€è¿›è¡Œnfdsæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆç”¨æˆ·ç©ºé—´éå†è‹¥å¹²æ¬¡ï¼Œè‹¥å¹²æ¬¡é™·å…¥å†…æ ¸ â†’ ç”¨æˆ·é™·å…¥ä¸€æ¬¡å†…æ ¸ï¼Œåœ¨å†…æ ¸å†…éƒ¨éå†ï¼‰

  > çŠ¶æ€çš„è¿”å›æ˜¯é€šè¿‡å°†fd_setæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´

å¼Šç«¯ï¼šåœ¨nfdså¤§çš„æƒ…å†µä¸‹ï¼šâ‘  å°†nfdsæ‹·è´åˆ°å†…æ ¸æ€çš„å¤§å¼€é”€ï¼›â‘¡ å†…æ ¸éå†çš„å¤§å¼€é”€ï¼›â‘¢ åªæ”¯æŒ1024ä¸ªï¼Œå¤ªå°äº†ï¼Œè‹¥è¦å¢åŠ ï¼Œé™¤éä¿®æ”¹æºç å¹¶é‡æ–°ç¼–è¯‘å†…æ ¸ï¼›â‘£ è°ƒç”¨selectåï¼Œæ ¹æ®è¿”å›å€¼ > 0èƒ½å¤Ÿåˆ¤æ–­å‘ç”Ÿäº†äº‹ä»¶ï¼Œä½†å…·ä½“ä¸çŸ¥é“æ˜¯å“ªé‡Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼Œå¿…é¡»éå†æ¯ä¸ªfd_setçš„æ¯ä¸€ä½ï¼Œç¡®å®šå“ªä¸€ä½ä¸º1ï¼Œè¿™ä¸€ä½çš„ç´¢å¼•ä½ç½®å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå†ä»¤ç¨‹åºè¿›è¡ŒIOæ“ä½œ

### æµç¨‹ç®€æ

> å‚è€ƒï¼š
>
> - [https://www.cnblogs.com/zengzy/p/5113910.html](https://www.cnblogs.com/zengzy/p/5113910.html)
> - [https://baijiahao.baidu.com/s?id=1710440642419184726&wfr=spider&for=pc](https://baijiahao.baidu.com/s?id=1710440642419184726&wfr=spider&for=pc)
> - [https://www.cnblogs.com/tomato0906/articles/7590746.html](https://www.cnblogs.com/tomato0906/articles/7590746.html)

1. è°ƒç”¨selectï¼Œoså°†select()çš„å‚æ•°æ‹·è´è¿›å†…æ ¸ï¼Œå³æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦æ‹·è´è¿›å†…æ ¸
2. åº•å±‚æ‰§è¡Œdo_selectï¼Œéå†æ‰€æœ‰0~nfds-1çš„æ–‡ä»¶æè¿°ç¬¦ï¼›å¯¹æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨æ‰€å±çš„é©±åŠ¨ç¨‹åºçš„pollå‡½æ•°ï¼Œåšäº†ä¸¤ä»¶äº‹ï¼š
   - å°†å½“å‰çº¿ç¨‹æŒ‚åˆ°æ–‡ä»¶æè¿°ç¬¦çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼ˆLinuxä¸­ç­‰å¾…é˜Ÿåˆ—æ˜¯å’Œæ–‡ä»¶ä¸€ä¸€å¯¹åº”çš„ï¼‰
   - åˆ¤æ–­å¯¹åº”socketä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¹¶å°†ç»“æœæ ‡è®°åœ¨è¿”å›å€¼ä¸Š
3. éå†ä¸€éå
   - å¦‚æœæŸä¸ªé©±åŠ¨ä¸Šé¢æœ‰äº‹ä»¶å‘ç”Ÿï¼Œåˆ™è¿”å›ï¼Œå¹¶å°†fd_setä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œä¾›ç”¨æˆ·å¤„ç†
   - å¦‚æœéƒ½æ²¡æœ‰äº‹ä»¶ï¼Œåˆ™çº¿ç¨‹è¿›å…¥é˜»å¡
     - å½“æŸä¸ªé©±åŠ¨ä¸Šæœ‰æ•°æ®åˆ°æ¥ï¼Œå‘ç”Ÿä¸­æ–­ï¼Œä¸­æ–­ç¨‹åºä¼šå”¤é†’å¯¹åº”ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œé‡æ–°å¼€å§‹do_selectä¸­çš„å¾ªç¯ï¼Œå¦‚æœæœ‰æ•°æ®ï¼Œåˆ™åœ¨fd_setä¸­è®°å½•ä¸‹ç»“æœï¼Œæœ€åï¼Œå°†è¯¥çº¿ç¨‹ä»æ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè¿”å›ç»“æœ
     - å½“é˜»å¡åˆ°è¾¾è¶…æ—¶æ—¶é—´åï¼Œä¹Ÿä¼šé‡å¯å¾ªç¯
4. ç”¨æˆ·éå†ä¸‰ä¸ªfd_setï¼Œæ ¹æ®å¯¹åº”ä½ç½®æ‰¾åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä½œç›¸åº”å¤„ç†

## poll

![image-20211210161825305](imgs\netty\35.png)

```c
struct pollfd {
    int fd;        /* æ–‡ä»¶æè¿°ç¬¦ */
    short events; /* ç­‰å¾…çš„äº‹ä»¶ */
    short revents; /* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */
};
```

pollçš„å®ç°å’Œselectéå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯æè¿°fdé›†åˆçš„æ–¹å¼ä¸åŒï¼Œpollä½¿ç”¨pollfdç»“æ„è€Œä¸æ˜¯selectçš„fd_setç»“æ„ï¼Œä¸”ä¸é™åˆ¶1024ï¼Œå…¶ä»–çš„éƒ½å·®ä¸å¤šï¼›æ­¤å¤–ï¼Œè°ƒç”¨selectæ—¶éœ€è¦è‡ªå®šä¹‰è¯»ã€å†™ã€å¼‚å¸¸çš„fd_setï¼Œè€Œpollæä¾›äº†pollfdæ•°ç»„ï¼Œæ¯ä¸ªpollfdå…ƒç´ åŒ…å«æ–‡ä»¶æè¿°ç¬¦å’Œè¦ç›‘å¬çš„äº‹ä»¶ï¼Œä»¥åŠå¯¹åº”äº§ç”Ÿäº†çš„äº‹ä»¶ï¼ŒåŠ å…¥æ—¶ç›´æ¥å¾€pollfdæ•°ç»„ä¸­æ”¾å°±è¡Œï¼Œè¿”å›æ—¶å»æŸ¥çœ‹revents

> å³æƒ³è¦æ³¨å†Œä¸€ä¸ªç›‘å¬è¯»äº‹ä»¶çš„fdï¼Œå‡è®¾ä¸º7
>
> åœ¨selectä¸­ï¼š
>
> ```c++
> fd_set rfds;//å®šä¹‰ä¸€ä¸ªè¯»é›†åˆ
> struct timeval tv;//å®šä¹‰è¶…æ—¶ç»“æ„ä½“
> int retval;//è¿”å›å€¼
> 
> /* ç›‘å¬æ ‡å‡†è¾“å…¥*/
> FD_ZERO(&rfds);//å°†é›†åˆæ¸…0
> FD_SET(7, &rfds);//å°†æè¿°ç¬¦7æ·»åŠ è¿›å»
> 
> /* è®¾ç½®è¶…æ—¶ */
> tv.tv_sec = 5;
> tv.tv_usec = 0;
> /* å¼€å§‹ç›‘å¬ï¼Œå†™äº‹ä»¶å’Œå¼‚å¸¸ä¸ç›‘å¬ */
> retval = select(8, &rfds, NULL, NULL, &tv);
> ```
>
> åœ¨pollä¸­ï¼š
>
> ```c++
> struct pollfd pfds[1];
> pfds[0].fd=7;
> pfds[0].events=POLLIN;//è¯»äº‹ä»¶
> 
> retval = poll(pfds, 8,-1);
> ```
>
> æ–¹ä¾¿äº†å¾ˆå¤š

## epoll

### ç»†èŠ‚

![image-20211210162320729](imgs\netty\36.png)

> è¿”å›epollå¥æŸ„ï¼Œåˆ›å»ºçº¢é»‘æ ‘ï¼Œç”¨äºå­˜æ”¾fdï¼ˆç”¨epitemåŒ…è£…ï¼‰

![image-20211210112417854](imgs\netty\34.png)

> å‚æ•°åˆ†åˆ«æ˜¯ï¼šepollå¥æŸ„ï¼ˆæè¿°ç¬¦ï¼‰ã€æ“ä½œã€socketã€è¦ç›‘å¬çš„äº‹ä»¶

![image-20211210162418418](imgs\netty\37.png)

> è¿”å›äº‹ä»¶çš„ä¸ªæ•°
>
> epoll_waitä¸­çš„eventsæ˜¯ä¸ªä¼ å‡ºå‚æ•°ï¼ˆæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯¹å®ƒçš„ä¿®æ”¹å½“ç„¶æ˜¯è°ƒç”¨è€…å¯è§çš„ï¼Œç›¸å½“äºJavaä¸­çš„å¼•ç”¨ç±»å‹çš„å‚æ•°ï¼‰ï¼Œäº‹ä»¶å’Œå¯¹åº”çš„fdç­‰ç­‰éƒ½åœ¨è¿™é‡Œï¼Œå°±å¾ˆæ–¹ä¾¿
>
> ![image-20211210162705232](imgs\netty\38.png)

æ”¹è¿›ï¼š

selectå’Œpolléƒ½åªæä¾›äº†ä¸€ä¸ªå‡½æ•°â€”â€”selectæˆ–è€…pollå‡½æ•°ã€‚è€Œepollæä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼Œepoll_create,epoll_ctlå’Œepoll_waitï¼Œepoll_createæ˜¯åˆ›å»ºä¸€ä¸ªepollå¥æŸ„ï¼›epoll_ctlæ˜¯æ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼›epoll_waitåˆ™æ˜¯ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿ

1. é‡å¤æ‹·è´fdï¼Œè§£å†³æ–¹æ¡ˆï¼šå†…æ ¸å¼€è¾Ÿç©ºé—´å­˜æ”¾fd

   > æ¯æ¬¡è°ƒç”¨epoll_ctlæ—¶æ³¨å†Œfdæ—¶å°±æ‹·è´è¿›å†…æ ¸çš„æŸä¸ªå¼€è¾Ÿå¥½çš„ç©ºé—´ï¼Œé¿å…äº†é‡å¤æ‹·è´

2. æ¯è°ƒç”¨ä¸€æ¬¡select/pollï¼Œå°±ä¼šå…¨éƒ¨é‡æ–°éå†ä¸€æ¬¡ï¼Œè§£å†³æ–¹æ¡ˆï¼šåˆ©ç”¨å›è°ƒæœºåˆ¶ï¼Œå°†å°±ç»ªçš„IOæ“ä½œå¯¹åº”çš„socketæ”¾å…¥readyé˜Ÿåˆ—

   > åœ¨epoll_ctlæ—¶ä¸ºfdæŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“è®¾å¤‡å°±ç»ªï¼ˆæ³¨å†Œæ—¶çš„ç±»å‹äº‹ä»¶å‘ç”Ÿï¼‰ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè€Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šæŠŠå°±ç»ªçš„fdåŠ å…¥ä¸€ä¸ªå°±ç»ªé“¾è¡¨ã€‚epoll_waitçš„å·¥ä½œå®é™…ä¸Šå°±æ˜¯åœ¨è¿™ä¸ªå°±ç»ªé“¾è¡¨ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰å°±ç»ªçš„fd

![image-20211210104832226](imgs\netty\33.png)

> epoll_waitåœ¨æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå³å°±ç»ªé“¾è¡¨ä¸ºç©ºæ—¶ä¼šé˜»å¡ï¼Œä¸è¿‡å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´
>
> select/pollåœ¨å†…æ ¸éå†æ—¶ä¼šé˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿï¼Œè¿™æœŸé—´å†…æ ¸ä¼šä¸æ–­å¾ªç¯éå†ï¼ŒåŒæ ·å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¸‹æ¬¡è°ƒç”¨ä¾ç„¶è¦é‡æ–°éå†ï¼Œè€Œepollåªéœ€è¦è°ƒç”¨epoll_waitå–ï¼Œæ˜¯æ¥è¿‘O(1)çš„

### æµç¨‹ç®€æ

> å‚è€ƒï¼š
>
> - [https://www.coonote.com/network-note/epoll-principle.html](https://www.coonote.com/network-note/epoll-principle.html)
> - :star::star: [https://zhuanlan.zhihu.com/p/361750240](https://zhuanlan.zhihu.com/p/361750240)
>
> ![img](imgs\netty\41.png)

1. è°ƒç”¨epoll_createï¼Œåœ¨å†…æ ¸ä¸­åˆ›å»ºä¸€ä¸ªeventpollçš„å®ä¾‹ï¼ŒåŒ…æ‹¬rdrï¼ˆçº¢é»‘æ ‘å¤´èŠ‚ç‚¹ï¼‰ï¼Œwait_queueï¼ˆå­˜æ”¾è°ƒç”¨epoll_waitçš„çº¿ç¨‹ï¼‰ï¼Œrdllistï¼ˆå­˜æ”¾å·²å°±ç»ªçš„epitemï¼‰
2. æ¯æ¬¡æ³¨å†Œä¸€ä¸ªè¿æ¥ï¼Œepoll_ctlå°†socketçš„ffdï¼ˆfdâ†’fileå®ä¾‹ï¼ˆstruct fileï¼‰â†’socketï¼Œffdâ†’fileå®ä¾‹â†’socketï¼Œä½†ä¸¤è€…æ˜¯ä¸åŒçš„æŒ‡é’ˆï¼‰å’ŒwqæŒ‡é’ˆã€event_pollæŒ‡é’ˆç­‰å°è£…æˆepitem
   - é¦–å…ˆå°†epitemæ·»åŠ åˆ°å¯¹åº”socketçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¤socketç­‰å¾…é˜Ÿåˆ—é¡¹ä¸­çš„privateé¡¹æŒ‡å‘nullï¼ˆä¸æŒ‡å‘çº¿ç¨‹ï¼Œè¡¨ç¤ºå”¤é†’å·¥ä½œä¸å†ä¸socketç»‘å®šï¼Œè€Œæ˜¯å…¨æƒäº¤ç»™epollç®¡ç†ï¼‰
   - æ¥ç€å°†å›è°ƒå‡½æ•°ep_poll_callbackæ³¨å†Œåˆ°å†…æ ¸ä¸­æ–­ç¨‹åºä¸­ï¼Œå¹¶åœ¨socketå¯¹åº”ç­‰å¾…é˜Ÿåˆ—ä¸­ä»¤funcé¡¹æŒ‡å‘å®ƒ
   - é€šè¿‡epæŒ‡é’ˆæ‰¾åˆ°event_pollå®ä¾‹ï¼Œå†æ‰¾åˆ°çº¢é»‘æ ‘ï¼Œåˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨è¯¥socketï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ 
3. è°ƒç”¨epoll_waitæ—¶ï¼Œé€šè¿‡event_pollæ‰¾åˆ°rdllist
   - å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºepitemå¹¶å¤„ç†
   - å¦‚æœä¸ºç©ºï¼Œåˆ™åŠ å…¥wqä¸­ï¼Œå¹¶å°†è‡ªå·±é˜»å¡èµ·æ¥
4. å½“æŸsocketæœ‰äº‹ä»¶åˆ°æ¥æ—¶ï¼Œè°ƒç”¨å¯¹åº”ç­‰å¾…é˜Ÿåˆ—ä¸­çš„funcä¹Ÿå°±æ˜¯ep_poll_callbackå‡½æ•°
   - å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„epitemä»çº¢é»‘æ ‘rdrç§»åˆ°å°±ç»ªé“¾è¡¨rdllist
   - æ ¹æ®epitemæ‰¾åˆ°wqï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é˜»å¡çš„çº¿ç¨‹ï¼Œå”¤é†’å®ƒ

## æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘

> å‚è€ƒï¼š[https://blog.csdn.net/daaikuaichuan/article/details/83862311?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164000455316780264098548%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=164000455316780264098548&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-83862311.pc_search_result_cache&utm_term=epoll%E5%8E%9F%E7%90%86&spm=1018.2226.3001.4187](https://blog.csdn.net/daaikuaichuan/article/details/83862311?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164000455316780264098548%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=164000455316780264098548&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-83862311.pc_search_result_cache&utm_term=epoll%E5%8E%9F%E7%90%86&spm=1018.2226.3001.4187)

epollæœ‰EPOLLLTå’ŒEPOLLETä¸¤ç§è§¦å‘æ¨¡å¼ï¼ŒLTæ˜¯é»˜è®¤çš„æ¨¡å¼ï¼ŒETæ˜¯â€œé«˜é€Ÿâ€æ¨¡å¼ã€‚

- LTï¼ˆæ°´å¹³è§¦å‘ï¼‰æ¨¡å¼ä¸‹ï¼Œåªè¦è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿˜æœ‰æ•°æ®å¯è¯»ï¼Œæ¯æ¬¡ epoll_waitéƒ½ä¼šè¿”å›å®ƒçš„äº‹ä»¶ï¼Œæé†’ç”¨æˆ·ç¨‹åºå»æ“ä½œï¼›
- ETï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰æ¨¡å¼ä¸‹ï¼Œåœ¨å®ƒæ£€æµ‹åˆ°æœ‰ I/O äº‹ä»¶æ—¶ï¼Œé€šè¿‡ epoll_wait è°ƒç”¨ä¼šå¾—åˆ°æœ‰äº‹ä»¶é€šçŸ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¢«é€šçŸ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚å¯è¯»ï¼Œåˆ™å¿…é¡»å°†è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸€ç›´è¯»åˆ°ç©ºï¼Œè®© errno è¿”å› EAGAIN ä¸ºæ­¢ï¼Œå¦åˆ™ä¸‹æ¬¡çš„ epoll_wait ä¸ä¼šè¿”å›ä½™ä¸‹çš„æ•°æ®ï¼Œä¼šä¸¢æ‰äº‹ä»¶ã€‚å¦‚æœETæ¨¡å¼ä¸æ˜¯éé˜»å¡çš„ï¼Œé‚£è¿™ä¸ªä¸€ç›´è¯»æˆ–ä¸€ç›´å†™åŠ¿å¿…ä¼šåœ¨æœ€åä¸€æ¬¡é˜»å¡ã€‚

ã€epollä¸ºä»€ä¹ˆè¦æœ‰EPOLLETè§¦å‘æ¨¡å¼ï¼Ÿã€‘ï¼š

â€ƒâ€ƒå¦‚æœé‡‡ç”¨EPOLLLTæ¨¡å¼çš„è¯ï¼Œç³»ç»Ÿä¸­ä¸€æ—¦æœ‰å¤§é‡ä½ ä¸éœ€è¦è¯»å†™çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒä»¬æ¯æ¬¡è°ƒç”¨epoll_waitéƒ½ä¼šè¿”å›ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½å¤„ç†ç¨‹åºæ£€ç´¢è‡ªå·±å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ•ˆç‡.ã€‚è€Œé‡‡ç”¨EPOLLETè¿™ç§è¾¹ç¼˜è§¦å‘æ¨¡å¼çš„è¯ï¼Œå½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œepoll_wait()ä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨epoll_wait()æ—¶ï¼Œå®ƒä¸ä¼šé€šçŸ¥ä½ ï¼Œä¹Ÿå°±æ˜¯å®ƒåªä¼šé€šçŸ¥ä½ ä¸€æ¬¡ï¼Œç›´åˆ°è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå‡ºç°ç¬¬äºŒæ¬¡å¯è¯»å†™äº‹ä»¶æ‰ä¼šé€šçŸ¥ä½ ï¼ï¼ï¼è¿™ç§æ¨¡å¼æ¯”æ°´å¹³è§¦å‘æ•ˆç‡é«˜ï¼Œç³»ç»Ÿä¸ä¼šå……æ–¥å¤§é‡ä½ ä¸å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦

# Java NIO

> æ³¨æ„ï¼šæ˜¯Java New IOï¼Œæ“ä½œç³»ç»Ÿä¸­NIOæ˜¯æŒ‡Non-Blocking IOï¼Œæ˜¯å†…æ ¸æä¾›çš„SOCK_NONBLOCåŠŸèƒ½ï¼ˆæŒ‡ä»¤`man accept`æŸ¥çœ‹ï¼‰
>
> ![image-20211209225356014](imgs\netty\30.png)
>
> Javaä¸­å¯ä»¥è®¾ç½®é˜»å¡å’Œéé˜»å¡æ¨¡å¼ï¼Œè¯æ˜ä¸æ˜¯å•æŒ‡Non-Blocking IOï¼›å®é™…ä¸Šï¼ŒJava NIOæ˜¯å¤šè·¯å¤ç”¨ï¼Œselectã€epollç­‰éƒ½æ˜¯éœ€è¦é˜»å¡çš„
>
> ```java
> ServerSocketChannel socketChannel = ServerSocketChannel.open();
> socketChannel.bind(new InetSocketAddress(8080));
> // true - blocking;  false - non-blocking
> socketChannel.configureBlocking(true); 
> ```

## Java IOæµç¨‹

> [https://mp.weixin.qq.com/s?__biz=MzkzNTEwOTAxMA==&mid=2247491660&idx=1&sn=a7d79ec4cc3f40e7b9a9018436a7377a&chksm=c2b1a8b1f5c621a7268ca298598a15c4ac575790628651e5651925b5efd96ebc0046796ef5b1&token=570732653&lang=zh_CN#rd](https://mp.weixin.qq.com/s?__biz=MzkzNTEwOTAxMA==&mid=2247491660&idx=1&sn=a7d79ec4cc3f40e7b9a9018436a7377a&chksm=c2b1a8b1f5c621a7268ca298598a15c4ac575790628651e5651925b5efd96ebc0046796ef5b1&token=570732653&lang=zh_CN#rd)

> ä¸‹é¢ä¸»è¦è®¨è®ºçš„æ˜¯IOå°±ç»ªåçš„æµç¨‹ï¼ŒBIO/NIO/å¤šè·¯å¤ç”¨ä¸»è¦è®¨è®ºçš„æ˜¯ç­‰å¾…IOå°±ç»ªçš„é˜¶æ®µ

### ä¼ ç»ŸIO

![image-20211209004227281](imgs\netty\10.png)

**è¯»å†™æµç¨‹**

- å†™ï¼ˆæ£•è‰²çº¿æ¡ï¼‰ï¼š

  ç”¨æˆ·å‘Java heapçš„Bufferå¯¹è±¡å†™æ•°æ®å¹¶è°ƒç”¨ç›¸å…³api 

  â†’ cpuå°†æ•°æ®æ‹·è´åˆ°å †å¤–å†…å­˜çš„DirectBuffer 

  â†’ cpuè°ƒç”¨JNIçš„pwrite0/write0æ–¹æ³•å‘å†…æ ¸ç©ºé—´å†™ï¼ˆç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼‰ 

  â†’ DMAæ§åˆ¶å™¨å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç¡¬ç›˜/æ˜¾å¡ï¼ˆåˆ‡æ¢å›ç”¨æˆ·æ€ï¼‰

- è¯»ï¼ˆç»¿è‰²çº¿æ¡ï¼‰ï¼š

  ç”¨æˆ·è°ƒç”¨readç›¸å…³api 

  â†’ cpuè°ƒç”¨åˆ°åº•å±‚JNIçš„pread0/readæ–¹æ³•ï¼ˆç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼‰ 

  â†’ DMAå°†æ•°æ®ä»ç¡¬ç›˜/æ˜¾å¡æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œå¹¶è¯»åˆ°DirectBufferï¼ˆå†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼‰ 

  â†’ è¯»è¿›Java heapçš„Bufferå¯¹è±¡ï¼Œè¿”å›æ•°æ®

**æºç éªŒè¯**

ä»¥`FileChannel.write(ByteBuffer)`çš„å…³é”®è¯­å¥ä¸ºä¾‹ï¼š

ğŸ‘‰é¦–å…ˆè¿›å…¥å®ä¾‹æ–¹æ³•ï¼Œ`FileChannelImpl.write`

```java
public int write(ByteBuffer src) throws IOException {
    // ......ï¼ˆçœç•¥äº†å…¶ä»–éƒ¨åˆ†ï¼‰
            do {
                // ğŸ”¥å…³é”®è¯­å¥
                n = IOUtil.write(fd, src, -1, direct, alignment, nd);
            } while ((n == IOStatus.INTERRUPTED) && isOpen());
            // ......
}
```

ğŸ‘‰è¿›å…¥`IOUtil.write`

```java
static int write(FileDescriptor fd, ByteBuffer src, long position,
                 boolean directIO, int alignment, NativeDispatcher nd)
    throws IOException
{
    // å¦‚æœæ˜¯DirctBufferï¼Œç›´æ¥è°ƒç”¨writeFromNativeBufferå¹¶è¿”å›
    if (src instanceof DirectBuffer) {
        return writeFromNativeBuffer(fd, src, position, directIO, alignment, nd);
    }
    // ......
    ByteBuffer bb;
    if (directIO) {
        Util.checkRemainingBufferSizeAligned(rem, alignment);
        // ğŸ”¥å…³é”®è¯­å¥
        bb = Util.getTemporaryAlignedDirectBuffer(rem, alignment);
    } else {
        // ğŸ”¥å…³é”®è¯­å¥
        bb = Util.getTemporaryDirectBuffer(rem);
    }
    // ......
}
```

ğŸ‘‰è¿›å…¥`Util.getTemporaryDirectBuffer`æˆ–`Util.getTemporaryAlignedDirectBuffer`

```java
public static ByteBuffer getTemporaryDirectBuffer(int size) {
    if (isBufferTooLarge(size)) {
        return ByteBuffer.allocateDirect(size);
    }

    BufferCache cache = bufferCache.get();
    ByteBuffer buf = cache.get(size);
    if (buf != null) {
        return buf;
    } else {
// ......
        return ByteBuffer.allocateDirect(size);
    }
}
```

æœ€ç»ˆï¼Œéƒ½è¿”å›äº†ä¸€ä¸ª`ByteBuffer.allocateDirect(size);`ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªDirectBufferçš„å®ä¾‹å¯¹è±¡

ğŸ‘‰é‡æ–°è¿›å…¥`IOUtil.write`

æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œbbå°±æ˜¯ä¸€ä¸ªDirectBufferçš„å®ä¾‹å¯¹è±¡

```java
static int write(FileDescriptor fd, ByteBuffer src, long position,
                 boolean directIO, int alignment, NativeDispatcher nd)
    throws IOException
{
    // ......
    try {
        // ğŸ”¥å…³é”®è¯­å¥
        bb.put(src);
        bb.flip();
        // Do not update src until we see how many bytes were written
        src.position(pos);
		// ğŸ”¥å…³é”®è¯­å¥
        int n = writeFromNativeBuffer(fd, bb, position, directIO, alignment, nd);
        if (n > 0) {
            // now update src
            src.position(pos + n);
        }
        return n;
    } finally {
        Util.offerFirstTemporaryDirectBuffer(bb);
    }
}
```

è°ƒç”¨`bb.put(src);`å°†åŸByteBufferé‡Œçš„æ•°æ®å†™åˆ°DirectBuffer bbï¼ŒéªŒè¯äº†cpuå¤åˆ¶é‚£ä¸€æ­¥

ğŸ‘‰è¿›å…¥`writeFromNativeBuffer`

```java
private static int writeFromNativeBuffer(FileDescriptor fd, ByteBuffer bb,
                                         long position, boolean directIO,
                                         int alignment, NativeDispatcher nd)
    throws IOException
{
    // ......
    if (position != -1) {
        // ğŸ”¥å…³é”®è¯­å¥
        written = nd.pwrite(fd,
                            ((DirectBuffer)bb).address() + pos,
                            rem, position);
    } else {
        // ğŸ”¥å…³é”®è¯­å¥
        written = nd.write(fd, ((DirectBuffer)bb).address() + pos, rem);
    }
    if (written > 0)
        bb.position(pos + written);
    return written;
}
```

è°ƒç”¨äº†`write`å’Œ`pwrite`

ğŸ‘‰è¿›å…¥`write`å’Œ`pwrite`

å‘ç°è°ƒç”¨çš„æ˜¯`FileDispatcherImpl`çš„æ–¹æ³•ï¼š

```java
int write(FileDescriptor fd, long address, int len) throws IOException {
    return write0(fd, address, len, fdAccess.getAppend(fd));
}

int pwrite(FileDescriptor fd, long address, int len, long position)
    throws IOException
{
    return pwrite0(fd, address, len, position);
}
```

ç‚¹è¿›å»ä¸€çœ‹

```java
static native int write0(FileDescriptor fd, long address, int len, boolean append)
    throws IOException;

static native int pwrite0(FileDescriptor fd, long address, int len,
                         long position) throws IOException;
```

æ˜¯JNIè°ƒç”¨ï¼Œå‘èµ·äº†ç”¨æˆ·æ€å‘å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒéªŒè¯äº†æµç¨‹

> PSï¼šDMA
>
> å¯¹äºä¸€ä¸ªIOæ“ä½œè€Œè¨€ï¼Œéƒ½æ˜¯é€šè¿‡CPUå‘å‡ºå¯¹åº”çš„æŒ‡ä»¤æ¥å®Œæˆï¼Œä½†æ˜¯ç›¸æ¯”CPUæ¥è¯´ï¼ŒIOçš„é€Ÿåº¦å¤ªæ…¢äº†ï¼ŒCPUæœ‰å¤§é‡çš„æ—¶é—´å¤„äºç­‰å¾…IOçš„çŠ¶æ€ã€‚å› æ­¤å°±äº§ç”Ÿäº†DMAï¼ˆDirect Memory Accessï¼‰ç›´æ¥å†…å­˜è®¿é—®æŠ€æœ¯ï¼Œæœ¬è´¨ä¸Šæ¥è¯´ä»–å°±æ˜¯ä¸€å—ä¸»æ¿ä¸Šç‹¬ç«‹çš„èŠ¯ç‰‡ï¼Œé€šè¿‡å®ƒæ¥è¿›è¡Œå†…å­˜å’ŒIOè®¾å¤‡çš„æ•°æ®ä¼ è¾“ï¼Œä»è€Œå‡å°‘CPUçš„ç­‰å¾…æ—¶é—´

> PSï¼šå¾ˆå¤šäººä»¥ä¸ºDirectBufferæ˜¯å†…æ ¸æ€çš„ç¼“å†²åŒºï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼ŒDirectBufferæ˜¯ç”±malloc()æ–¹æ³•åˆ†é…çš„Javaå †å¤–ç©ºé—´ï¼Œä½†ä»æ˜¯ç”¨æˆ·ç©ºé—´
>
> æœ¬æ–‡å›¾ç‰‡ä¸ºäº†ç®€æ˜æ˜“æ‡‚ï¼Œå°†DirectBufferç”»åˆ°äº†å †å¤–ï¼Œå®é™…ä¸Šåœ¨Javaä¸­DirectBufferå¯¹è±¡è‚¯å®šæ˜¯åœ¨å †å†…çš„ï¼Œæ˜¯ä»–çš„addresså±æ€§ä¸ºå †å¤–çš„æŸä¸ªåœ°å€ï¼Œä¸€å—è°ƒç”¨ malloc() ç”³è¯·åˆ°çš„native memoryï¼Œç±»ä¼¼äºä¸‹å›¾ï¼š
>
> ![image-20211209093203742](imgs\netty\15.png)

> ğŸ”¥ä¸ºä»€ä¹ˆä¸€å®šè¦å…ˆæ‹·è´åˆ°DirectBufferï¼Ÿç›´æ¥ä»å †ä¸­çš„Bufferåˆ°å†…æ ¸ç©ºé—´ä¸å¯ä»¥å—ï¼Ÿ
>
> **å› ä¸ºHotSpot VMé‡Œçš„GCé™¤äº†CMSä¹‹å¤–éƒ½æ˜¯è¦ç§»åŠ¨å¯¹è±¡çš„**ï¼Œå½“ä¸€ä¸ªJavaé‡Œçš„ byte[] å¯¹è±¡çš„å¼•ç”¨ä¼ ç»™nativeä»£ç ï¼Œè®©nativeä»£ç ç›´æ¥è®¿é—®æ•°ç»„çš„å†…å®¹ï¼Œå°±å¿…é¡»è¦ä¿è¯nativeä»£ç åœ¨è®¿é—®çš„æ—¶å€™è¿™ä¸ª byte[] å¯¹è±¡ä¸èƒ½è¢«ç§»åŠ¨ï¼Œå³**è¿™ä¸ªåœ°å€ä¸Šçš„å†…å®¹ä¸èƒ½å¤±æ•ˆ**ï¼Œè¿™å°±ä¸ä¸Šé¢ç›¸æ‚–äº†ï¼Œå†…å­˜å¯èƒ½å› ä¸ºGCæ•´ç†å†…å­˜è€Œå¤±æ•ˆ
>
> æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š
>
> 1. æš‚æ—¶ç¦ç”¨GC
> 2. å…ˆæŠŠ HeapByteBuffer èƒŒåçš„ byte[] çš„å†…å®¹æ‹·è´åˆ°ä¸€ä¸ª DirectByteBuffer èƒŒåçš„native memoryå»ï¼ŒGCç®¡ä¸ç€äº†
>
> äºæ˜¯é‡‡ç”¨äº†æ–¹æ³•2ï¼Œæ•°æ®è¢«æ‹·è´åˆ°native memoryä¹‹åï¼Œå°±å°† DirectByteBuffer èƒŒåçš„native memoryåœ°å€ä¼ ç»™çœŸæ­£åšI/Oçš„å‡½æ•°ï¼Œä¿è¯åœ°å€ä¸ä¼šå¤±æ•ˆäº†

### ç›´æ¥å†…å­˜

> [https://www.zhihu.com/question/57374068](https://www.zhihu.com/question/57374068)

å¦‚æœæ˜¯ç›´æ¥ä½¿ç”¨å †å¤–å†…å­˜å‘¢ï¼Ÿ`ByteBuffer buffer = ByteBuffer.allocateDirect(x)`

![image-20211209013530875](imgs\netty\11.png)

å°±å°‘äº†ä¸€æ¬¡åœ¨Javaå †å†…å’Œå †å¤–ä¹‹é—´æ‹·è´çš„è¿‡ç¨‹ï¼Œæºç ä¸­è¡¨ç°ä¸ºï¼š

ğŸ‘‰è¿›å…¥`IOUtil.write`

```java
static int write(FileDescriptor fd, ByteBuffer src, long position,
                 boolean directIO, int alignment, NativeDispatcher nd)
    throws IOException
{
    // å¦‚æœæ˜¯DirctBufferï¼Œç›´æ¥è°ƒç”¨writeFromNativeBufferå¹¶è¿”å›
    if (src instanceof DirectBuffer) {
        return writeFromNativeBuffer(fd, src, position, directIO, alignment, nd);
    }
    // ......
}
```

### é›¶æ‹·è´ä¹‹â€”MMAP

> [https://www.zhihu.com/question/48161206](https://www.zhihu.com/question/48161206)

**é›¶æ‹·è´æ˜¯ä»€ä¹ˆï¼Ÿ**

é›¶æ‹·è´æŠ€æœ¯æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPUä¸éœ€è¦å…ˆå°†æ•°æ®ä»æŸå¤„å†…å­˜å¤åˆ¶åˆ°å¦ä¸€ä¸ªç‰¹å®šåŒºåŸŸï¼ˆä»¥å†…æ ¸çš„è§’åº¦çœ‹å¾…ï¼‰ï¼Œè¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºé€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶æ—¶èŠ‚çœCPUå‘¨æœŸå’Œå†…å­˜å¸¦å®½

ä¸€èˆ¬åœ¨Javaä¸­ï¼Œå¯ç”¨MMAPå®ç°é›¶æ‹·è´

**MMAPæ˜¯ä»€ä¹ˆï¼Ÿ**

æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–¹å¼ï¼Œå°†è™šæ‹Ÿåœ°å€çš„æŸä¸€æ®µä¸ç£ç›˜æ–‡ä»¶çš„æŸä¸€æ®µè¿›è¡Œæ˜ å°„ï¼Œé€ æˆç›´æ¥æ“ä½œç£ç›˜æ–‡ä»¶çš„å‡è±¡

```java
FileChannel fc = file.getChannel();
// è¿”å›DirectByteBufferå¯¹è±¡ï¼Œå»ºç«‹DirectByteBufferä¸ç£ç›˜æ–‡ä»¶ä¹‹é—´çš„æ˜ å°„
MappedByteBuffer map = fc.map(FileChannel.MapMode.READ_WRITE, 0, 5);
```

ä»¥è¯»æ“ä½œä¸ºä¾‹ï¼Œä»¥å¾€çš„IOï¼š

![image-20211209021458752](imgs\netty\12.png)

é‡‡ç”¨äº†MMAPï¼š

![image-20211209021921471](imgs\netty\13.png)

å°‘äº†ä¸€æ¬¡å†…æ ¸copyåˆ°ç”¨æˆ·ç©ºé—´çš„è¿‡ç¨‹

ä½†å®é™…ä¸Šï¼Œè¿˜æ˜¯ä¼šè¿›å…¥å†…æ ¸æ€çš„ï¼Œå› ä¸ºä¸€å¼€å§‹ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜æ˜¯ç©ºçš„ï¼Œmmapåªæ˜¯åšäº†æ˜ å°„ï¼Œæ²¡æœ‰æŠŠæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨åé¢è®¿é—®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½åˆ°å†…å­˜å°±ä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥å†…æ ¸ï¼Œå†…æ ¸ä¼šåˆ†é…å‡ºå¯¹åº”çš„ç‰©ç†é¡µï¼Œå¹¶æŠŠæ–‡ä»¶æ•°æ®ä»ç£ç›˜è¯»åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œç„¶åæŠŠç‰©ç†é¡µä¸è™šæ‹Ÿåœ°å€å»ºç«‹æ˜ å°„ï¼Œè¿™æ ·é—´æ¥æ˜ å°„äº†è™šæ‹Ÿåœ°å€ä¸æ–‡ä»¶ï¼Œç”¨æˆ·å°±å¯ä»¥è¯»å†™æ“ä½œäº†ã€‚æµç¨‹å¦‚ä¸‹ï¼š

![image-20211209022911884](imgs\netty\14.png)

1. å»ºç«‹mmapæ˜ å°„
2. ç”¨æˆ·è¿›è¡Œè¯»å†™æ“ä½œï¼Œå‘ç°å¯¹åº”çš„è™šæ‹Ÿåœ°å€é¡µæ¡†æ˜¯ç©ºçš„ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œé™·å…¥å†…æ ¸æ€
3. osæ ¹æ®mmapæ˜ å°„å…³ç³»æ‰¾åˆ°ç£ç›˜ä¸Šå¯¹åº”æ–‡ä»¶æ®µï¼Œè¯»åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶åœ¨mmuï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰ä¸‹å»ºç«‹è™šæ‹Ÿå†…å­˜åˆ°å¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„
4. è¯»æ“ä½œï¼Œç›´æ¥è¿”å›ç»“æœï¼›å†™æ“ä½œï¼Œå†™ç‰©ç†é¡µå¯¹åº”å†…å®¹ï¼Œç„¶åç³»ç»Ÿè°ƒç”¨fsyncåˆ·è„ï¼Œåˆ·å›ç£ç›˜

## Java NIOåŸç†

> å‚è€ƒï¼š[https://tech.meituan.com/2016/11/04/nio.html](https://tech.meituan.com/2016/11/04/nio.html)



## ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

### æ¦‚è¿°



### Buffer

#### æ¦‚è¿°

æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼ˆåº•å±‚ç”±æ•°ç»„å­˜å‚¨ï¼‰ã€‚Bufferæ˜¯ä¸€ä¸ªé¡¶å±‚çˆ¶ç±»ï¼Œå­ç±»æœ‰ByteBuffer*ï¼ˆæœ€å¸¸ç”¨ï¼‰*ã€IntBufferç­‰

åœ¨æ—§I/Oç±»åº“ä¸­ï¼ˆç›¸å¯¹java.nioåŒ…ï¼‰ä¸­çš„BufferedInputStreamã€BufferedOutputStreamã€BufferedReaderå’ŒBufferedWriteråœ¨å…¶å®ç°ä¸­éƒ½è¿ç”¨äº†ç¼“å†²åŒºã€‚java.nioåŒ…å…¬å¼€äº†Buffer APIï¼Œä½¿å¾—Javaç¨‹åºå¯ä»¥ç›´æ¥æ§åˆ¶å’Œè¿ç”¨ç¼“å†²åŒº

#### æºç åˆ†æ

ä»¥IntBufferä¸ºä¾‹

- åˆå§‹åŒ–

```java
IntBuffer intBuffer = IntBuffer.allocate(5);
```

```java
public static IntBuffer allocate(int capacity) {
    if (capacity < 0)
        throw new IllegalArgumentException();
    return new HeapIntBuffer(capacity, capacity);
}
```

è¿”å›ä¸€ä¸ªHeapIntBufferï¼Œcapacityä¸ºå‚æ•°

```java
HeapIntBuffer(int cap, int lim) {            // package-private
    super(-1, 0, lim, cap, new int[cap], 0);
    /*
    hb = new int[cap];
    offset = 0;
    */
}
```

è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å™¨

```java
IntBuffer(int mark, int pos, int lim, int cap,   // package-private
             int[] hb, int offset)
{
    super(mark, pos, lim, cap);
    this.hb = hb;
    this.offset = offset;
}
```

ç»“åˆä¸Šé¢å¯çŸ¥ï¼Œ`hb = new int[cap]`ï¼Œ`offset = 0`ï¼Œè°ƒç”¨äº†`super(mark, pos, lim, cap)`ï¼Œå…¶ä¸­ï¼š`mark=-1`ï¼Œ`pos=0`ï¼Œ`lim=æœ€åˆçš„capacity=5`ï¼Œ`cap=æœ€åˆçš„capacity=5`

```java
Buffer(int mark, int pos, int lim, int cap) {       // package-private
    if (cap < 0)
        throw new IllegalArgumentException("Negative capacity: " + cap);
    this.capacity = cap;
    limit(lim);
    position(pos);
    if (mark >= 0) {
        if (mark > pos)
            throw new IllegalArgumentException("mark > position: ("
                                               + mark + " > " + pos + ")");
        this.mark = mark;
    }
}
```

åˆ°æœ€é¡¶å±‚çš„æ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«ç»™Bufferçš„å››å¤§å±æ€§ï¼š`capacityã€limitã€positionã€mark`èµ‹å€¼ä¸º5ï¼Œ5ï¼Œ0ï¼Œ-1

åˆå§‹åŒ–é¡ºåºï¼šBuffer â†’ IntBuffer â†’ HeapIntBuffer

- æ·»åŠ 

```java
public abstract IntBuffer put(int i);
```

è¿”å›ä¸€ä¸ªIntBufferï¼Œè¯´æ˜æ˜¯é“¾å¼çš„ï¼Œä¸€æ¡è¯­å¥å¯ä»¥å¤šæ¬¡put

ç‚¹è¿›å®ç°ç±»çš„æ–¹æ³•

```java
public IntBuffer put(int x) {
    hb[ix(nextPutIndex())] = x;
    return this;
}
```

ç‚¹è¿›nextPutIndex

```java
final int nextPutIndex() {                          // package-private
    if (position >= limit)
        throw new BufferOverflowException();
    return position++;
}
```

è¿”å›çš„æ˜¯positionï¼Œå¹¶ä»¤position++ï¼Œç”±æ­¤å¯è§ï¼Œpositionç›¸å½“äºä¸€ä¸ªæ¸¸æ ‡çš„ä½œç”¨

ç‚¹è¿›ixæ–¹æ³•

```java
protected int ix(int i) {
    return i + offset;
}
```

offsetåˆå§‹åŒ–æ—¶è®¾ç½®ä¸º0ï¼Œæ‹‰ä¸‹æ¥æ•´ä½“çœ‹ä¸€ä¸‹ï¼Œå¤§æ¦‚å°±æ˜¯è¿™æ ·çš„æµç¨‹ï¼š`hb[position++]=x`

position>=limitï¼Œä¼šæŠ¥é”™

- è¯»å–

ä»¥ä¸€ä¸ªç°è±¡å¼€å¤´ï¼š

```java
IntBuffer intBuffer = IntBuffer.allocate(5);
intBuffer.put(1).put(2).put(3);
System.out.println(intBuffer.get());
```

æ‰“å°0ï¼Œä¸ºä½•ï¼Ÿ

ç‚¹è¿›get

```java
public int get() {
    return hb[ix(nextGetIndex())];
}

public int get(int i) {
    return hb[ix(checkIndex(i))];
}
```

```java
final int nextGetIndex() {                          // package-private
    if (position >= limit)
        throw new BufferUnderflowException();
    return position++;
}
```

å‘ç°ä»positionå¼€å§‹è¯»ï¼Œä¹Ÿå°±æ˜¯å°†è¦å†™çš„æ–°ä½ç½®ï¼Œè‡ªç„¶ä¼šè¯»åˆ°0ã€‚è¯»å®Œåposition++

- è¯»å†™åˆ‡æ¢

```java
intBuffer.flip();
```

```java
public final Buffer flip() {
    limit = position;
    position = 0;
    mark = -1;
    return this;
}
```

positionå†™åˆ°å“ªå„¿ï¼Œlimitå°±é™åˆ¶åˆ°å“ªå„¿ï¼›positionç½®ä½ï¼Œmarkç½®ä½

```java
IntBuffer intBuffer = IntBuffer.allocate(5);
intBuffer.put(1).put(2).put(3);
intBuffer.flip();
System.out.println(intBuffer.get());
```

è¿™æ ·ä¾¿å¯æ­£å¸¸ä»å¼€å¤´è¯»

**æ¯æ¬¡flipï¼Œlimitéƒ½ä¼šå˜æˆä¸Šæ¬¡è¯»/å†™çš„ä½ç½®ï¼Œç„¶åä»å¼€å¤´æˆ–è®¾ç½®çš„ä½ç½®å¾€åæ“ä½œ**

#### ç±»å‹åŒ–ä¸åªè¯»

- ç±»å‹åŒ–

```java
ByteBuffer buffer = ByteBuffer.allocate(3);
// ä¼šå¼‚å¸¸ï¼Œåªç»™bufferåˆ†é…äº†3å­—èŠ‚ï¼Œæº¢å‡ºäº†
buffer.putInt(1);

ByteBuffer buffer = ByteBuffer.allocate(14);
buffer.putInt(1).putChar('A').putLong(8);
buffer.flip();
// å¿…é¡»æŒ‰é¡ºåºè¯»å–
System.out.println(buffer.getInt());
System.out.println(buffer.getChar());
System.out.println(buffer.getLong());
```

- åªè¯»

```java
ByteBuffer buffer = ByteBuffer.allocate(1024);
buffer.putInt(1).putChar('A').putLong(8);
buffer.flip();
// åªè¯»
// è¿”å›HeapByteBufferRçš„å®ä¾‹ï¼Œåšå†™æ“ä½œä¼šæŠ›å‡ºå¼‚å¸¸
buffer = buffer.asReadOnlyBuffer();
buffer.putInt(1);
// Exception in thread "main" java.nio.ReadOnlyBufferException
// at java.base/java.nio.HeapByteBufferR.putInt(HeapByteBufferR.java:448)
// at Demo.main(Demo.java:20)
```

#### å †å¤–å†…å­˜

å¯ç›´æ¥å¯¹å †å¤–å†…å­˜æ“ä½œï¼Œå‡å°‘äº†ä¸€æ¬¡å †å¤–å†…å­˜å’Œå †å†…å†…å­˜ä¹‹é—´æ‹·è´çš„è¿‡ç¨‹



```java
try(RandomAccessFile file = new RandomAccessFile("1.txt", "rw");
    FileChannel fc = file.getChannel();){
    // ä»¥è¯»å†™æ¨¡å¼
    // ä»0ä½ç½®å¼€å§‹å°†æ–‡ä»¶åé¢5ä¸ªå­—èŠ‚å¤§å°æ˜ å°„åˆ°å †å¤–å†…å­˜(ä¸æ˜¯ç´¢å¼•ä½ç½®ä¸º5)
    // è¿”å›DirectByteBufferå¯¹è±¡
    MappedByteBuffer map = fc.map(FileChannel.MapMode.READ_WRITE, 0, 5);
    map.put(3, (byte) 'X');
} catch (IOException e) {
    e.printStackTrace();
}
```

#### åˆ†æ•£å’Œèšé›†

- åˆ†æ•£ï¼ˆScatteringï¼‰



- èšé›†ï¼ˆGatheringï¼‰



### Channel

#### æ¦‚è¿°

![img](imgs\netty\9.png)

- åŒå‘çš„ï¼ˆä¸åŒäºæµï¼‰ï¼Œå¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™
- æ˜¯ä¸€ä¸ªæ¥å£

å¸¸ç”¨ï¼š

- FileChannelï¼šæ–‡ä»¶è¯»å†™
- DatagramChannelï¼šUDPè¯»å†™
- ServerSocketChannelã€SocketChannelï¼šTCPè¯»å†™

å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ç»™å®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªServerSocketChannelï¼Œåç»­ä¸è¯¥å®¢æˆ·ç«¯çš„é€šä¿¡éƒ½åŸºäºè¿™ä¸ªChannelæ¥è¿›è¡Œ

#### FileChannel

æ–‡ä»¶è¯»å†™æ“ä½œ

å¸¸ç”¨æ–¹æ³•ï¼š

```java
public int read(ByteBuffer dst);
public int write(ByteBuffer src);
public long transferFrom(ReadableByteChannel src, long position, long count);
public long transferTo(long position, long count, WritableByteChannel dst);
```

> ä¸åŒäºInputStream/Readeråªèƒ½è¯»ï¼ŒOutputStream/Writeråªèƒ½å†™

- è¯»å†™

å®ç°1.txtçš„å†…å®¹æ‹·è´åˆ°2.txt

```java
public static void main(String[] args) throws IOException {
    File file = new File("1.txt");
    File file2 = new File("2.txt");
    ByteBuffer buffer = ByteBuffer.allocate(5);
    try (FileChannel readChannel = FileChannel.open(file.toPath(), StandardOpenOption.READ);
         FileChannel writeChannel = FileChannel.open(file2.toPath(), StandardOpenOption.WRITE)){
        while (true){
            // ç¼“å­˜è¯»å®Œåéœ€è¦clearï¼Œå¦åˆ™ä¼šä¸€ç›´read 0ï¼Œpositionä½ç½®ä¸å˜
            buffer.clear();
            int read = readChannel.read(buffer);
            if (read == -1){
                break;
            }
            // æ³¨æ„Javaå†…ç å’Œå¤–ç çš„åŒºåˆ«ï¼Œå†…ç UTF-16ï¼Œå­—ç¬¦å 2å­—èŠ‚ï¼›å¤–ç æ¯”å¦‚UTF-8å­˜å‚¨ä¸­è‹±æ–‡æ˜¯ä¸ç­‰é•¿çš„
            System.out.print(new String(buffer.array(), "UTF-8"));

            //è¯»å†™åˆ‡æ¢
            buffer.flip();
            writeChannel.write(buffer);
        }
    }
}
```

- é€šé“æ‹·è´

```java
public static void main(String[] args) throws IOException {
    File file = new File("1.txt");
    File file2 = new File("2.txt");
    try (FileChannel readChannel = FileChannel.open(file.toPath(), StandardOpenOption.READ);
         FileChannel writeChannel = FileChannel.open(file2.toPath(), StandardOpenOption.WRITE)){
        writeChannel.transferFrom(readChannel, 0, readChannel.size());
    }
}
```

#### SocketChannel

æœåŠ¡ç«¯ï¼šServerSocketChannelï¼›å®¢æˆ·ç«¯ï¼šSocketChannel

å¯ä»¥çœ‹ä½œæ˜¯Socketçš„å†ä¸€å±‚æŠ½è±¡ï¼Œåœ¨Socketçš„åŸºç¡€ä¸Šå°è£…äº†ä¸€äº›å…¶ä»–çš„å†…å®¹

### Selector

**å¤šè·¯å¤ç”¨å™¨**

Linuxä¸‹é»˜è®¤ä¸ºepollï¼Œä¸è¿‡ä¼šåˆ¤æ–­å†…æ ¸ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬ä¸ºselectæˆ–epollï¼›åŸºæœ¬æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒselect

> windowsä¸‹çš„AIOï¼Œå³IOCPæ²¡æœ‰æ”¯æŒï¼Œå› ä¸ºè€ƒè™‘åˆ°Javaç¨‹åºå¤§å¤šè·‘åœ¨LinuxæœåŠ¡å™¨ä¸Š

#### æ¦‚è¿°

- ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªè¿æ¥
- å¤šä¸ªChannelä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ªSelector
- èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæœ‰ï¼Œä¾¿è·å–å¯¹åº”äº‹ä»¶å¹¶å¤„ç†
- ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå‡å°‘äº†å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€

#### å…³é”®ä»£ç 

```java
select(); // é˜»å¡è°ƒç”¨select/poll/epoll
select(long timeout); // é˜»å¡ç›´åˆ°è¶…æ—¶
selectNow(); // æœ‰æ— äº‹ä»¶äº§ç”Ÿéƒ½ç›´æ¥è¿”å›
```

```java
// è¿”å›æ‰€æœ‰å‘å¤šè·¯å¤ç”¨å™¨æ³¨å†Œçš„SelectionKey
keys(); 
// è¿”å›æ‰€æœ‰äº§ç”Ÿäº‹ä»¶å¯¹åº”çš„SelectionKey
selectedKey(); 
```

> SelectionKeyï¼š
>
> ```java
> public abstract class SelectionKey {
>     protected SelectionKey() { }
>     // è¿”å›channelï¼Œç†è§£æˆsocketï¼Œæˆ–fd
>     public abstract SelectableChannel channel();
>     // è¿”å›å¤šè·¯å¤ç”¨å™¨
>     public abstract Selector selector();
>     // å–æ¶ˆä¸€ä¸ªselectionKeyå¹¶æ·»åŠ åˆ°cancelled-key set ä¸­
>     // æ‰€å…³è”çš„channelå¹¶æ²¡æœ‰ç«‹å³è¢«æ’¤é”€æ³¨å†Œ
>     // ç›´åˆ°å‘ç”Ÿä¸‹æ¬¡ select, è¿™äº›channelæ‰è¢«ä»selectorä¸­æ’¤é”€ç™»è®°
>     public abstract void cancel();
>     // è¿”å›è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹
>     public abstract int interestOps();
>     // è®¾ç½®è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹
>     public abstract SelectionKey interestOps(int ops);
>     // æˆ–æ“ä½œ
>     public int interestOpsOr(int ops) {
>         synchronized (this) {
>             int oldVal = interestOps();
>             interestOps(oldVal | ops);
>             return oldVal;
>         }
>     }
>     // ä¸æ“ä½œ
>     public int interestOpsAnd(int ops) {
>         synchronized (this) {
>             int oldVal = interestOps();
>             interestOps(oldVal & ops);
>             return oldVal;
>         }
>     }
> 	// å°±ç»ªçš„äº‹ä»¶çš„ç±»å‹
>     public abstract int readyOps();
> 
>     public static final int OP_READ = 1 << 0;
>     public static final int OP_WRITE = 1 << 2;
>     public static final int OP_CONNECT = 1 << 3;
>     public static final int OP_ACCEPT = 1 << 4;
>     // è¯»äº‹ä»¶æ˜¯å¦å‘ç”Ÿ
>     public final boolean isReadable() {
>         return (readyOps() & OP_READ) != 0;
>     }
> 	// å†™äº‹ä»¶æ˜¯å¦å‘ç”Ÿ
>     public final boolean isWritable() {
>         return (readyOps() & OP_WRITE) != 0;
>     }
> 	// è¿æ¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿ
>     public final boolean isConnectable() {
>         return (readyOps() & OP_CONNECT) != 0;
>     }
> 	// acceptæ˜¯å¦å‘ç”Ÿ
>     public final boolean isAcceptable() {
>         return (readyOps() & OP_ACCEPT) != 0;
>     }
> 
>     // -- Attachments --
> 
>     private volatile Object attachment;
>     private static final AtomicReferenceFieldUpdater<SelectionKey,Object>
>         attachmentUpdater = AtomicReferenceFieldUpdater.newUpdater(
>             SelectionKey.class, Object.class, "attachment"
>         );
>     public final Object attach(Object ob) {
>         return attachmentUpdater.getAndSet(this, ob);
>     }
>     public final Object attachment() {
>         return attachment;
>     }
> 
> }
> ```
>
> å®ä¾‹SelectionKeyImplï¼š
>
> ```java
> public final class SelectionKeyImpl
>     extends AbstractSelectionKey
> {
>     private static final VarHandle INTERESTOPS =
>             ConstantBootstraps.fieldVarHandle(
>                     MethodHandles.lookup(),
>                     "interestOps",
>                     VarHandle.class,
>                     SelectionKeyImpl.class, int.class);
> 
>     // è¿æ¥å¥æŸ„
>     private final SelChImpl channel;
>     private final SelectorImpl selector;
> 
>     // ç›‘å¬çš„äº‹ä»¶
>     private volatile int interestOps;
>     // è¿”å›çš„äº‹ä»¶ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ„Ÿè§‰è·Ÿpollfdæˆ–è€…epoll_eventçš„ç»“æ„æŒºåƒçš„
>     private volatile int readyOps;
> 
>     // registered events in kernel, used by some Selector implementations
>     private int registeredEvents;
> 
>     // index of key in pollfd array, used by some Selector implementations
>     private int index;
>     //......
> }
> ```
>
> å¯ä»¥ç®€å•åœ¨æŠ½è±¡å±‚é¢å¯¹æ ‡ä¸€ä¸‹ï¼š
>
> - å¯¹æ ‡selectä¸­çš„fd_setå’Œå¯¹åº”ä½ç½®ç½®ä¸º1çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå·²äº§ç”Ÿçš„äº‹ä»¶+fdï¼‰
> - pollä¸­çš„reventsä¸ä¸ºç©ºçš„pollfd
> - ä»¥åŠepollå°±ç»ªé“¾è¡¨ä¸­çš„epoll_eventï¼ˆæ„Ÿè§‰è¿™ä¸ªæœ€è´´åˆ‡ï¼‰

## Nettyæ€æƒ³

### Javaå¤šè·¯å¤ç”¨ç®€å•å®ç°

```java
public class Demo {
    public static void main(String[] args) throws IOException {
        // åˆ›å»ºå¤šè·¯å¤ç”¨å™¨
        Selector selector = Selector.open();
        // å°†æœåŠ¡ç«¯çš„ServerSocketæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå¹¶ç›‘å¬acceptäº‹ä»¶
        ServerSocketChannel ss = ServerSocketChannel.open();
        ss.bind(new InetSocketAddress(9090));
        // è®¾ç½®ä¸ºéé˜»å¡
        ss.configureBlocking(false);
        // æ³¨å†Œ
        ss.register(selector, SelectionKey.OP_ACCEPT);
        while (true){
            // é˜»å¡ï¼Œå¦‚æœç›‘å¬åˆ°æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¿›å…¥ifå¾ªç¯
            if (selector.select() > 0){
                // éå†å°±ç»ªé“¾è¡¨
                for (SelectionKey k: selector.selectedKeys()){
                    // å‘ç°acceptäº‹ä»¶çŠ¶æ€æ˜¾ç¤ºå°±ç»ª
                    if (k.isAcceptable()){
                        // æ‹¿åˆ°æ³¨å†Œä¸ºacceptçš„ServerSocketå¥æŸ„
                        ServerSocketChannel readySs = (ServerSocketChannel) k.channel();
                        // å¼€å§‹ç›‘å¬ï¼Œè¿™é‡Œæ˜¯ä¸€å¼€å§‹å°±è®¾ç½®äº†éé˜»å¡çš„
                        SocketChannel accept = readySs.accept();
                        // ç›‘å¬åˆ°å®¢æˆ·ç«¯è¿æ¥
                        if (accept != null){
                            System.out.println("------------------------------");
                            System.out.println("TYPE: ACCEPT");
                            System.out.println("å®¢æˆ·ç«¯åœ°å€ä¸º: " + accept.getRemoteAddress());
                            // å®¢æˆ·ç«¯channelè®¾ç½®ä¸ºéé˜»å¡
                            accept.configureBlocking(false);
                            // å°†å®¢æˆ·ç«¯channelæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå¹¶ç›‘å¬è¯»çŠ¶æ€
                            accept.register(selector, SelectionKey.OP_READ);
                        }
                    }else if (k.isReadable()){
                        // å®¢æˆ·ç«¯channelè¯»äº‹ä»¶äº§ç”Ÿ
                        SocketChannel readyCs = (SocketChannel) k.channel();
                        ByteBuffer buffer = ByteBuffer.allocate(1024);
                        int read = readyCs.read(buffer);
                        if (read > 0){
                            System.out.println("------------------------------");
                            System.out.println("TYPE: READ, è¾“å…¥æ¥æºä¸º: " + readyCs.getRemoteAddress());
                            // æ³¨æ„ç›´æ¥å†…å­˜ä¸æ”¯æŒarray()æ–¹æ³•
                            System.out.println(new String(buffer.array(), 0, read));
                        }
                    }
                    selector.selectedKeys().clear();
                }
            }
        }
    }
}
```

![image-20211211031528967](imgs\netty\39.png)

æ³¨æ„çš„ç‚¹ï¼š

- éœ€è¦å†™æˆéé˜»å¡çš„ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸

  > whyï¼Ÿ
  >
  > æ¯æ¬¡é€šè¿‡ `read` ç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®æ—¶ï¼Œæœ€å¤šåªèƒ½è¯»å–ç¼“å†²åŒºå¤§å°çš„å­—èŠ‚æ•°ï¼›å¦‚æœæŸä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸€æ¬¡æ€§æ”¶åˆ°çš„æ•°æ®è¶…è¿‡äº†ç¼“å†²åŒºçš„å¤§å°ï¼Œé‚£ä¹ˆéœ€è¦å¯¹å…¶ `read` å¤šæ¬¡æ‰èƒ½å…¨éƒ¨è¯»å–å®Œæ¯•
  >
  > - **`select`** **å¯ä»¥ä½¿ç”¨é˜»å¡ I/O**ã€‚é€šè¿‡ `select` è·å–åˆ°æ‰€æœ‰å¯è¯»çš„æ–‡ä»¶æè¿°ç¬¦åï¼Œéå†æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œ`read` **ä¸€æ¬¡**æ•°æ®
  >   - è¿™äº›æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯å¯è¯»çš„ï¼Œå› æ­¤å³ä½¿ `read` æ˜¯é˜»å¡ I/Oï¼Œä¹Ÿä¸€å®šå¯ä»¥è¯»åˆ°æ•°æ®ï¼Œä¸ä¼šä¸€ç›´é˜»å¡ä¸‹å»
  >   - `select` é‡‡ç”¨æ°´å¹³è§¦å‘æ¨¡å¼ï¼Œå› æ­¤å¦‚æœç¬¬ä¸€æ¬¡ `read` æ²¡æœ‰è¯»å–å®Œå…¨éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨ `select` æ—¶ä¾ç„¶ä¼šè¿”å›è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥å†æ¬¡ `read`
  >   - **`select`** **ä¹Ÿå¯ä»¥ä½¿ç”¨éé˜»å¡ I/O**ã€‚å½“éå†æŸä¸ªå¯è¯»æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œä½¿ç”¨ `for` å¾ªç¯è°ƒç”¨ `read` **å¤šæ¬¡**ï¼Œç›´åˆ°è¯»å–å®Œæ‰€æœ‰æ•°æ®ä¸ºæ­¢ï¼ˆè¿”å› `EWOULDBLOCK`ï¼‰ã€‚è¿™æ ·åšä¼šå¤šä¸€æ¬¡ `read` è°ƒç”¨ï¼Œä½†å¯ä»¥å‡å°‘è°ƒç”¨ `select` çš„æ¬¡æ•°
  >
  > - åœ¨ `epoll` çš„è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªä¼šåœ¨æ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»/å¯å†™çŠ¶æ€å‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œæ‰ä¼šæ”¶åˆ°æ“ä½œç³»ç»Ÿçš„é€šçŸ¥
  >   - å› æ­¤ï¼Œå¦‚æœä½¿ç”¨ `epoll` çš„**è¾¹ç¼˜è§¦å‘æ¨¡å¼**ï¼Œåœ¨æ”¶åˆ°é€šçŸ¥æ—¶ï¼Œ**å¿…é¡»ä½¿ç”¨éé˜»å¡ I/Oï¼Œå¹¶ä¸”å¿…é¡»å¾ªç¯è°ƒç”¨** `read` **æˆ–** `write` **å¤šæ¬¡ï¼Œç›´åˆ°è¿”å›** `EWOULDBLOCK` **ä¸ºæ­¢**ï¼Œç„¶åå†è°ƒç”¨ `epoll_wait` ç­‰å¾…æ“ä½œç³»ç»Ÿçš„ä¸‹ä¸€æ¬¡é€šçŸ¥
  >   - å¦‚æœæ²¡æœ‰ä¸€æ¬¡æ€§è¯»/å†™å®Œæ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåœ¨æ“ä½œç³»ç»Ÿçœ‹æ¥è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå°†ä¸ä¼šå†å‘èµ·é€šçŸ¥ï¼Œè°ƒç”¨ `epoll_wait` ä¼šä½¿å¾—è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸€ç›´ç­‰å¾…ä¸‹å»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯çš„å“åº”ï¼Œä¸šåŠ¡æµç¨‹æ— æ³•èµ°å®Œ
  >   - è¿™æ ·åšçš„å¥½å¤„æ˜¯æ¯æ¬¡è°ƒç”¨ `epoll_wait` éƒ½æ˜¯**æœ‰æ•ˆ**çš„â€”â€”ä¿è¯æ•°æ®å…¨éƒ¨è¯»å†™å®Œæ¯•äº†ï¼Œç­‰å¾…ä¸‹æ¬¡é€šçŸ¥ã€‚åœ¨æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœè°ƒç”¨ `epoll_wait` æ—¶æ•°æ®æ²¡æœ‰è¯»/å†™å®Œæ¯•ï¼Œä¼šç›´æ¥è¿”å›ï¼Œå†æ¬¡é€šçŸ¥ã€‚å› æ­¤è¾¹ç¼˜è§¦å‘èƒ½æ˜¾è‘—å‡å°‘äº‹ä»¶è¢«è§¦å‘çš„æ¬¡æ•°
  >
  >   ä¸ºä»€ä¹ˆ `epoll` çš„**è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸èƒ½ä½¿ç”¨é˜»å¡ I/O**ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œè¾¹ç¼˜è§¦å‘æ¨¡å¼éœ€è¦å¾ªç¯è¯»/å†™ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ‰€æœ‰æ•°æ®ã€‚å¦‚æœä½¿ç”¨é˜»å¡ I/Oï¼Œé‚£ä¹ˆä¸€å®šä¼šåœ¨æœ€åä¸€æ¬¡è°ƒç”¨ï¼ˆæ²¡æœ‰æ•°æ®å¯è¯»/å†™ï¼‰æ—¶é˜»å¡ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸ç»“æŸ

- æ¯æ¬¡è¯»å–selectedKeyså¹¶IOæ“ä½œåï¼Œéœ€è¦clear

  > whyï¼Ÿ
  >
  > selectoræ— æ³•è‡ªå·±ç§»é™¤selectedKeyï¼Œè‹¥æ²¡æœ‰ç§»é™¤çš„è¯ï¼Œä¸‹æ¬¡éå†è¿˜ä¼šéå†åˆ°å¯¹åº”çš„selectedKeyï¼Œå–å‡ºchannelï¼Œè¿›è¡ŒIOæ“ä½œï¼Œè€Œæ­¤æ—¶channelæ˜¯æ²¡æœ‰å°±ç»ªçš„ï¼Œåˆ™ç¨‹åºå°±ä¼šå‡ºç°å¼‚å¸¸
  >
  > ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºä¾‹ï¼Œå¦‚æœç¬¬ä¸€æ¬¡acceptä¹‹åæ²¡æœ‰æ¸…é™¤ï¼Œé¦–å…ˆè½®è¯¢åˆ°åˆšåˆšæ·»åŠ çš„readï¼Œå¦‚æœå¯readï¼Œåˆ™readå‡ºæ¥ï¼›å¦‚æœè¿˜ä¸å¯ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œé˜»å¡åœ¨selectã€‚æ¥ç€ï¼Œå¦ä¸€ä¸ªè¿æ¥å¼€å¯ï¼Œè¿›å…¥å¾ªç¯ï¼Œç„¶è€Œç”±äºä¸Šä¸€ä¸ªacceptçš„keyæ²¡æœ‰æ¸…é™¤ï¼Œäºæ˜¯éå†åˆ°ä¸Šä¸€ä¸ªacceptï¼Œç›‘å¬å·²ç»å»ºç«‹çš„è¿æ¥çš„å®¢æˆ·ç«¯channelï¼Œæ‰€ä»¥å¯¼è‡´åé¢ä¸€ç³»åˆ—æ··ä¹±

è€ƒè™‘å‡ºç°è¿™æ ·çš„æƒ…å†µï¼šæŸæ¬¡å‘ç”Ÿä¸€ä¸ªè¯»äº‹ä»¶ï¼Œå¦‚æœå†…å®¹å¾ˆå¤šï¼Œåˆæ˜¯åœ¨whileå¾ªç¯é‡Œé¢è¯»å–çš„è¯ï¼Œå°±ä¼šåœ¨å¡åœ¨å¾ªç¯é‡Œé¢ç›´åˆ°è¯»å–å®Œæˆï¼Œå¦‚æœè¯»å–è¿‡ç¨‹ä¸­æœ‰acceptäº‹ä»¶å‘ç”Ÿï¼Œåˆ™è¿™ä¸ªå®¢æˆ·ç«¯ä¹Ÿå¾—ç­‰ï¼Œæ›´åˆ«è¯´å®¢æˆ·ç«¯ä¼ æ¥çš„æ•°æ®è¯»å–äº†

æ€è€ƒè¿™æ ·çš„è§£å†³ï¼šå¼€å¯å¤šä¸ªselectorï¼Œä¸€ä¸ªselectorå¡åœ¨è¯»å–é‚£å„¿æ—¶ï¼Œå¦ä¸€ä¸ªå¯ä»¥å·¥ä½œã€‚è¿›ä¸€æ­¥åœ°ï¼Œä»¤ä¸€ä¸ªselectorå®Œå…¨ç”¨äºç›‘å¬acceptäº‹ä»¶ï¼Œå¦å¤–çš„selectorï¼Œå¤„ç†å…¶ä»–ç±»å‹çš„äº‹ä»¶ï¼Œä¸‹é¢æ¥ç®€å•å®ç°ä¸€ä¸‹

### Javaå¤šselectorå®ç°

> è®¾è®¡æˆä¸»çº¿ç¨‹çš„selectorå®Œå…¨ç”¨äºç›‘å¬accpetï¼Œå…¶ä»–ç”¨äºå¤„ç†å…¶ä»–äº‹ä»¶

ä¸»çº¿ç¨‹åšaccpectå·¥ä½œï¼Œæ¯æ¬¡ç›‘å¬åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå°†å®¢æˆ·ç«¯çš„è¯»å–äº‹ä»¶æ³¨å†Œåˆ°selector1å’Œselector2å…¶ä¸­éšæœºä¸€ä¸ª

```java
public class Demo {
    static volatile Selector selectorAccept = null;
    static volatile Selector selectorRead1 = null;
    static volatile Selector selectorRead2 = null;
    static volatile Selector[] selectorReads = null;
    public static void main(String[] args) throws IOException {
        selectorAccept = Selector.open();
        selectorRead1 = Selector.open();
        selectorRead2 = Selector.open();
        selectorReads = new Selector[]{selectorRead1, selectorRead2};
        ServerSocketChannel ss = ServerSocketChannel.open();
        ss.bind(new InetSocketAddress(9090));
        ss.configureBlocking(false);
        ss.register(selectorAccept, SelectionKey.OP_ACCEPT);
        new Thread(new Task(selectorRead1), "thread-A").start();
        new Thread(new Task(selectorRead2), "thread-B").start();
        // å¼€å§‹ç›‘å¬accept
        while (true) {
            synchronized (selectorAccept) {
                if (selectorAccept.select() > 0) {
                    for (SelectionKey sk : selectorAccept.selectedKeys()) {
                        if (sk.isAcceptable()) {
                            ServerSocketChannel ssc = (ServerSocketChannel) sk.channel();
                            SocketChannel accept = ssc.accept();
                            if (accept != null) {
                                System.out.println("----------ACCEPT----------");
                                System.out.println("çº¿ç¨‹: " + Thread.currentThread().getName());
                                System.out.println("æ–°çš„å®¢æˆ·ç«¯æ¥äº†: " + accept.getRemoteAddress());
                                accept.configureBlocking(false);
                                int random = new Random().nextInt(2);
                                accept.register(selectorReads[random], SelectionKey.OP_READ);
                            }
                        }
                    }
                    selectorAccept.selectedKeys().clear();
                }
            }
        }
    }
}
class Task implements Runnable{
    private final Selector selector;

    public Task(Selector selector) {
        this.selector = selector;
    }

    @Override
    public void run() {
        synchronized (selector){
            while (true){
                try {
                    if (selector.select(200) > 0) {
                        handler(selector);
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    static void handler(Selector selectorRead) throws IOException {
        for (SelectionKey sk: selectorRead.selectedKeys()){
            SocketChannel readChannel = (SocketChannel) sk.channel();
            ByteBuffer buffer = ByteBuffer.allocate(1);
            int read;
            System.out.println("----------READ----------");
            System.out.println("æº: " + readChannel.getRemoteAddress());
            System.out.println("å¤„ç†çº¿ç¨‹: " + Thread.currentThread().getName());
            while (true){
                buffer.clear();
                if ((read = readChannel.read(buffer)) == 0){
                    break;
                }
                if (read < 0){
                    // è¿æ¥æ–­å¼€ï¼Œå–æ¶ˆæ³¨å†Œ
                    sk.cancel();
                    System.out.print("è¿æ¥æ–­å¼€: " + readChannel.getRemoteAddress());
                    break;
                }
                System.out.print(new String(buffer.array(), 0, read, "UTF-8"));
            }
            System.out.println();
        }
        selectorRead.selectedKeys().clear();
    }
}
```

> :boom:!!!**æ³¨æ„**ï¼š
>
> 1. registerä¸€å®šè¦åœ¨æ²¡æœ‰é˜»å¡åœ¨selectæ—¶è°ƒç”¨ï¼Œå¦åˆ™ä¼šå¤±æ•ˆã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¸¦è¶…æ—¶çš„select
> 2. å¦‚æœå®¢æˆ·ç«¯å¼ºåˆ¶æ–­å¼€ï¼Œæ³¨å†Œåœ¨ selector ä¸­çš„ channel ä¼šä¸æ–­è§¦å‘ read äº‹ä»¶ï¼Œæ­¤æ—¶è°ƒç”¨ read() æ–¹æ³•å»è¯»æ•°æ®ä¼šè§¦å‘ IOException å¼‚å¸¸ï¼Œå› æ­¤éœ€è¦é€šè¿‡ try catch æ•æ‰å¤„ç†ï¼Œé¿å…æœåŠ¡å™¨å› ä¸ºå¼‚å¸¸è€Œè¢«å¼ºåˆ¶åœæ­¢ã€‚éœ€è¦è°ƒç”¨ cancel() æ–¹æ³•è¿›è¡Œæ³¨é”€ï¼Œä» selector ä¸­æ³¨é”€è§¦å‘å¼‚å¸¸ SelectionKey æ‰€å¯¹åº”çš„ channel

æ­£å¸¸è¿è¡Œï¼š

![image-20211213105607078](imgs\netty\40.png)

# å‚è€ƒ

- [æœåŠ¡å™¨ç½‘ç»œç¼–ç¨‹ä¹‹ IO æ¨¡å‹ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844903812738596878)
- [https://tech.meituan.com/2016/11/04/nio.html](https://tech.meituan.com/2016/11/04/nio.html)
- [https://mp.weixin.qq.com/s?__biz=MzkzNTEwOTAxMA==&mid=2247491660&idx=1&sn=a7d79ec4cc3f40e7b9a9018436a7377a&chksm=c2b1a8b1f5c621a7268ca298598a15c4ac575790628651e5651925b5efd96ebc0046796ef5b1&token=570732653&lang=zh_CN#rd](https://mp.weixin.qq.com/s?__biz=MzkzNTEwOTAxMA==&mid=2247491660&idx=1&sn=a7d79ec4cc3f40e7b9a9018436a7377a&chksm=c2b1a8b1f5c621a7268ca298598a15c4ac575790628651e5651925b5efd96ebc0046796ef5b1&token=570732653&lang=zh_CN#rd)
- [https://www.zhihu.com/question/48161206](https://www.zhihu.com/question/48161206)
- [https://www.zhihu.com/question/57374068](https://www.zhihu.com/question/57374068)
- [https://www.cnblogs.com/baxianhua/p/9285102.html](https://www.cnblogs.com/baxianhua/p/9285102.html)
- [https://blog.csdn.net/Stephen___Qin/article/details/120466415](https://blog.csdn.net/Stephen___Qin/article/details/120466415)
- [https://blog.csdn.net/wangwei19871103/article/details/104080859](https://blog.csdn.net/wangwei19871103/article/details/104080859)
- [https://www.cnblogs.com/Anker/p/3265058.html](https://www.cnblogs.com/Anker/p/3265058.html)
- :star:[é©¬å£«å…µNetty](https://www.bilibili.com/video/BV1Af4y117ZK?p=1&spm_id_from=pageDriver)
